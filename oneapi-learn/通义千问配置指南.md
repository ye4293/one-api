# 通义千问渠道配置指南

## 🎯 配置概览

**密钥状态**: ✅ 已验证可用
**API密钥**: sk-512dd9a7f2d9468b9e65f25afa911e2d
**支持模型**: qwen-turbo, qwen-plus, qwen-max, qwen-max-longcontext
**系统地址**: http://localhost:3000

---

## 方法一：通过Web界面配置（推荐）

### 1. 访问管理后台

```bash
打开浏览器访问: http://localhost:3000
```

### 2. 登录系统

- 使用管理员账号登录
- 如果是首次使用，需要先注册管理员账号

### 3. 添加渠道

导航到：**渠道管理** → **添加新渠道**

填写以下信息：

| 字段 | 值 | 说明 |
|------|-----|------|
| **渠道类型** | `阿里云` 或 `Ali` | 选择阿里云/通义千问 |
| **渠道名称** | `通义千问-主渠道` | 自定义名称，便于识别 |
| **密钥** | `sk-512dd9a7f2d9468b9e65f25afa911e2d` | 你的API密钥 |
| **Base URL** | `https://dashscope.aliyuncs.com` | 阿里云DashScope端点 |
| **模型列表** | `qwen-turbo,qwen-plus,qwen-max,qwen-max-longcontext` | 支持的模型（逗号分隔） |
| **优先级** | `0` | 数字越小优先级越高 |
| **权重** | `100` | 负载均衡权重 |
| **状态** | `启用` | 启用此渠道 |

### 4. 保存并测试

- 点击"保存"按钮
- 点击"测试"按钮验证渠道可用性
- 如果测试成功，渠道配置完成

---

## 方法二：通过API配置（高级）

### 1. 获取管理员Token

首先需要登录获取Token：

```bash
# 登录（替换为你的用户名和密码）
curl -X POST http://localhost:3000/api/user/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_password"
  }'

# 响应中会包含 token
```

### 2. 创建渠道

```bash
# 使用获取的token创建渠道
curl -X POST http://localhost:3000/api/channel \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <YOUR_ADMIN_TOKEN>" \
  -d '{
    "type": 14,
    "name": "通义千问-主渠道",
    "key": "sk-512dd9a7f2d9468b9e65f25afa911e2d",
    "base_url": "https://dashscope.aliyuncs.com",
    "models": "qwen-turbo,qwen-plus,qwen-max,qwen-max-longcontext",
    "priority": 0,
    "weight": 100,
    "status": 1
  }'
```

**参数说明**：
- `type: 14` - 阿里云渠道类型ID（需要确认实际值）
- `status: 1` - 1表示启用，0表示禁用

---

## 方法三：直接操作数据库（不推荐）

⚠️ **警告**: 仅在必要时使用，可能导致数据不一致

```bash
# 连接MySQL数据库
docker exec -it one-api-mysql mysql -u oneapi -p123456 one-api

# 插入渠道记录
INSERT INTO channels (type, name, `key`, base_url, models, priority, weight, status, created_time)
VALUES (
  14,  -- 阿里云类型
  '通义千问-主渠道',
  'sk-512dd9a7f2d9468b9e65f25afa911e2d',
  'https://dashscope.aliyuncs.com',
  'qwen-turbo,qwen-plus,qwen-max,qwen-max-longcontext',
  0,   -- 优先级
  100, -- 权重
  1,   -- 启用
  UNIX_TIMESTAMP()
);
```

---

## 配置验证

### 1. 查看渠道列表

访问: http://localhost:3000 → 渠道管理

应该能看到刚才添加的"通义千问-主渠道"

### 2. 测试渠道

在渠道列表中，点击"测试"按钮，系统会发送测试请求验证：
- ✅ 密钥是否有效
- ✅ 网络连接是否正常
- ✅ 模型是否可用

### 3. 通过One API调用

配置完成后，可以通过One API统一接口调用：

```bash
# 获取用户Token（在Web界面：令牌管理 → 创建新令牌）
USER_TOKEN="sk-xxxxxx"  # 你的One API用户令牌

# 调用通义千问（通过One API）
curl -X POST http://localhost:3000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ${USER_TOKEN}" \
  -d '{
    "model": "qwen-turbo",
    "messages": [
      {
        "role": "user",
        "content": "你好，请介绍一下自己"
      }
    ]
  }'
```

---

## 支持的模型详情

| 模型名称 | 说明 | 适用场景 |
|---------|------|---------|
| **qwen-turbo** | 通义千问快速版 | 日常对话、简单任务 |
| **qwen-plus** | 通义千问增强版 | 复杂任务、专业领域 |
| **qwen-max** | 通义千问旗舰版 | 最强性能、高质量输出 |
| **qwen-max-longcontext** | 长文本版本 | 长文档分析、长对话 |

---

## 高级配置选项

### 1. 启用联网搜索

在模型名称后添加 `-internet` 后缀：

```json
{
  "model": "qwen-turbo-internet",
  "messages": [...]
}
```

### 2. 配置多个渠道（负载均衡）

可以添加多个通义千问渠道，系统会根据权重分配请求：

```
渠道1: 权重=70, 优先级=0
渠道2: 权重=30, 优先级=0
```

### 3. 设置模型倍率

在系统配置中，可以为不同模型设置不同的计费倍率：

- qwen-turbo: 1.0x
- qwen-plus: 2.0x
- qwen-max: 5.0x

---

## 常见问题排查

### Q1: 渠道测试失败，提示401错误

**原因**: API密钥无效或已过期

**解决方案**:
1. 检查密钥是否正确复制
2. 登录阿里云DashScope控制台验证密钥状态
3. 重新生成新的密钥

### Q2: 调用时提示"no available channel"

**原因**: 没有启用的可用渠道

**解决方案**:
1. 检查渠道状态是否为"启用"
2. 检查模型列表是否包含你请求的模型
3. 查看渠道日志排查问题

### Q3: 密钥在哪里查看？

**阿里云DashScope控制台**:
1. 访问: https://dashscope.console.aliyun.com/
2. 登录你的阿里云账号
3. 在左侧菜单找到"API-KEY管理"
4. 查看或创建新的API密钥

### Q4: 如何设置渠道优先级？

**优先级规则**:
- 数字越小，优先级越高
- 优先级=0 > 优先级=1 > 优先级=2
- 相同优先级的渠道，根据权重分配

**示例配置**:
```
主渠道: 优先级=0, 权重=100  (首选)
备用渠道: 优先级=1, 权重=100  (主渠道失败时使用)
```

---

## 监控与维护

### 查看渠道使用情况

导航到：**渠道管理** → 选择渠道 → **统计信息**

可以看到：
- ✅ 总调用次数
- ✅ 成功率
- ✅ Token使用量
- ✅ 费用统计

### 查看调用日志

导航到：**日志** → **调用日志**

可以查看：
- 请求时间
- 使用的模型
- Token消耗
- 响应状态

---

## 安全建议

### 🚨 重要！密钥安全

1. **不要在代码中硬编码密钥**
   ```javascript
   // ❌ 错误
   const API_KEY = "sk-512dd9a7f2d9468b9e65f25afa911e2d"

   // ✅ 正确
   const API_KEY = process.env.OPENAI_API_KEY
   ```

2. **定期轮换密钥**
   - 建议每3个月更换一次
   - 发现泄露立即更换

3. **使用环境变量**
   ```bash
   # .env 文件
   ALI_API_KEY=sk-512dd9a7f2d9468b9e65f25afa911e2d
   ```

4. **设置访问限制**
   - 在阿里云控制台设置IP白名单
   - 设置每日调用上限

---

## 下一步

配置完成后，建议：

1. ✅ **测试所有支持的模型**
   - 测试 qwen-turbo
   - 测试 qwen-plus
   - 测试 qwen-max

2. ✅ **配置计费规则**
   - 设置模型倍率
   - 设置用户分组

3. ✅ **设置监控告警**
   - 余额不足提醒
   - 异常调用告警

4. ✅ **阅读学习路径文档**
   - 参考: `/Users/yueqingli/code/one-api/学习路径.md`
   - 深入理解系统架构

---

**配置完成时间**: 2025-12-23
**文档版本**: 1.0

**需要帮助？**
- 查看系统日志: `tail -f logs/oneapi.out`
- 查看渠道测试脚本: `./test_ali_key.sh`
- 参考学习文档: `学习路径.md`
