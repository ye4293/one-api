# ⚠️ 重要：需要重启服务才能生效

## 🔄 已修复的代码需要重启

您遇到的错误：
```json
{
    "message": "Error: Invalid file 'input_reference': unsupported mimetype ('application/octet-stream')..."
}
```

**已修复**：代码已更新，会从 URL 中提取 `.jpg` 扩展名。

**但是**：✅ **您需要重启服务才能生效！**

---

## 🔄 重启步骤

### 1. 停止当前服务

在运行 `one-api.exe` 的终端窗口中：
- 按 `Ctrl + C` 停止服务

### 2. 重新编译（可选，推荐）

```powershell
cd C:\Users\brows\Desktop\ezlinkai
go build -o one-api.exe .
```

### 3. 重启服务

```powershell
.\one-api.exe
```

---

## 🧪 重启后重新测试

```bash
curl -X POST http://localhost:3000/v1/video/generations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -d '{
    "model": "sora-2",
    "prompt": "A calico cat playing a piano on stage",
    "input_reference": "https://svip-8.rcouyi.com/file/upload/2025/09/17/1968331882076573696.jpg"
  }'
```

---

## ✅ 修复的逻辑

对于您的 URL：`https://svip-8.rcouyi.com/.../1968331882076573696.jpg`

**新代码会**：
1. 下载文件
2. 检查 Content-Type（可能是 application/octet-stream）
3. 从 URL 检测到 `.jpg` 扩展名 ✅
4. 使用 `filename = "input_reference.jpg"` ✅
5. OpenAI 可以正确识别为 JPEG 格式 ✅

---

## 📋 检测优先级

1. **Content-Type** (HTTP Header)
2. **URL 扩展名** (如 .jpg, .png)
3. **文件头检测** (二进制数据)
4. **默认** (.jpg)

您的 URL 会在第 2 步被识别为 `.jpg`！

---

## 🎯 重启前后对比

### 重启前（旧代码）❌
```
URL: .../1968331882076573696.jpg
→ 可能提取不到扩展名
→ filename = "input_reference" (无扩展名)
→ OpenAI 识别为 application/octet-stream
→ 拒绝请求
```

### 重启后（新代码）✅
```
URL: .../1968331882076573696.jpg
→ 检测到 .jpg 后缀
→ filename = "input_reference.jpg"
→ OpenAI 识别为 image/jpeg
→ 接受请求 ✅
```

---

## 💡 如果重启后还有问题

请提供服务器日志，查看这一行：
```
Input reference URL: ..., Content-Type: ..., detected filename: ...
```

这会告诉我们检测到的文件名是什么。

---

**请立即重启服务，然后重新测试！**

