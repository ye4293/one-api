# æ›´æ–°çš„è‡ªåŠ¨ç¦ç”¨é€»è¾‘è¯´æ˜

## ğŸ¯ å®ç°çš„åŠŸèƒ½é€»è¾‘

æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼Œå·²å®ç°ä»¥ä¸‹ç²¾ç¡®çš„è‡ªåŠ¨ç¦ç”¨é€»è¾‘ï¼š

### 1. å•Keyæ¸ é“è‡ªåŠ¨ç¦ç”¨

**è¡Œä¸º**ï¼š
- é‡åˆ°é”™è¯¯æ—¶ï¼Œç›´æ¥ç¦ç”¨æ•´ä¸ªæ¸ é“
- ç¦ç”¨åŸå› ï¼šå…·ä½“çš„APIé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚ "Incorrect API key provided"ï¼‰

**å­˜å‚¨ä½ç½®**ï¼š
- `channels.auto_disabled_reason` = å…·ä½“é”™è¯¯ä¿¡æ¯
- `channels.auto_disabled_time` = ç¦ç”¨æ—¶é—´æˆ³
- `channels.status` = 3 (ChannelStatusAutoDisabled)

**é‚®ä»¶é€šçŸ¥**ï¼š
- å‘é€æ¸ é“çº§åˆ«çš„ç¦ç”¨é€šçŸ¥
- åŒ…å«å…·ä½“çš„é”™è¯¯åŸå› å’Œæ—¶é—´

### 2. å¤šKeyæ¸ é“è‡ªåŠ¨ç¦ç”¨

#### 2.1 å•ä¸ªKeyç¦ç”¨
**è¡Œä¸º**ï¼š
- å•ä¸ªKeyé‡åˆ°é”™è¯¯æ—¶ï¼Œåªç¦ç”¨è¯¥Key
- æ¸ é“ç»§ç»­è¿è¡Œï¼ˆå¦‚æœè¿˜æœ‰å…¶ä»–å¯ç”¨Keyï¼‰

**å­˜å‚¨ä½ç½®**ï¼š
- `channels.multi_key_info.key_metadata[index].disabled_reason` = å…·ä½“é”™è¯¯ä¿¡æ¯
- `channels.multi_key_info.key_metadata[index].disabled_time` = ç¦ç”¨æ—¶é—´æˆ³
- `channels.multi_key_info.key_metadata[index].status_code` = HTTPçŠ¶æ€ç 
- `channels.multi_key_info.key_status_list[index]` = 3 (ChannelStatusAutoDisabled)

**é‚®ä»¶é€šçŸ¥**ï¼š
- å‘é€Keyçº§åˆ«çš„ç¦ç”¨é€šçŸ¥
- åŒ…å«Keyç´¢å¼•ã€è„±æ•Keyã€é”™è¯¯åŸå› ã€çŠ¶æ€ç 

#### 2.2 æ‰€æœ‰Keyéƒ½è¢«ç¦ç”¨
**è¡Œä¸º**ï¼š
- å½“æœ€åä¸€ä¸ªå¯ç”¨Keyè¢«ç¦ç”¨æ—¶ï¼Œè‡ªåŠ¨ç¦ç”¨æ•´ä¸ªæ¸ é“

**å­˜å‚¨ä½ç½®**ï¼š
- `channels.auto_disabled_reason` = "all keys disabled" ï¼ˆå›ºå®šæ–‡æœ¬ï¼‰
- `channels.auto_disabled_time` = ç¦ç”¨æ—¶é—´æˆ³
- `channels.status` = 3 (ChannelStatusAutoDisabled)
- å„Keyçš„å…·ä½“ç¦ç”¨åŸå› ä»ä¿ç•™åœ¨ `key_metadata` ä¸­

**é‚®ä»¶é€šçŸ¥**ï¼š
- å‘é€æ¸ é“çº§åˆ«çš„å®Œå…¨ç¦ç”¨é€šçŸ¥
- è¯´æ˜æ‰€æœ‰Keyéƒ½å·²ç¦ç”¨

## ğŸ“‹ å‰ç«¯å±•ç¤ºé€»è¾‘

### 1. æ¸ é“åˆ—è¡¨é¡µé¢

**å•Keyæ¸ é“**ï¼š
```
çŠ¶æ€åˆ—ï¼š[è‡ªåŠ¨ç¦ç”¨]
ç¦ç”¨åŸå› åˆ—ï¼šæ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯
```

**å¤šKeyæ¸ é“**ï¼š
```
çŠ¶æ€åˆ—ï¼š[è‡ªåŠ¨ç¦ç”¨] æˆ– [å¯ç”¨]
ç¦ç”¨åŸå› åˆ—ï¼š
- å¦‚æœæ¸ é“è¢«ç¦ç”¨ï¼šæ˜¾ç¤º "all keys disabled"
- å¦‚æœæ¸ é“æ­£å¸¸ï¼šæ˜¾ç¤º "-" æˆ– "éƒ¨åˆ†Keyç¦ç”¨"
```

### 2. å¤šKeyç®¡ç†é¡µé¢

åœ¨å¤šKeyæ¸ é“çš„è¯¦æƒ…é¡µé¢ä¸­ï¼š
```
Keyåˆ—è¡¨è¡¨æ ¼ï¼š
| Keyç´¢å¼• | çŠ¶æ€      | ç¦ç”¨åŸå›                         | ç¦ç”¨æ—¶é—´        | çŠ¶æ€ç  |
|---------|-----------|--------------------------------|----------------|--------|
| Key #0  | å¯ç”¨      | -                              | -              | -      |
| Key #1  | è‡ªåŠ¨ç¦ç”¨  | Incorrect API key provided     | 2024-01-15 14:30 | 401   |
| Key #2  | è‡ªåŠ¨ç¦ç”¨  | You exceeded your current quota | 2024-01-15 15:20 | 429   |
```

## ğŸ”„ å®Œæ•´çš„å¤„ç†æµç¨‹

### å•Keyæ¸ é“é”™è¯¯å¤„ç†æµç¨‹
```mermaid
graph TD
    A[APIè¯·æ±‚å¤±è´¥] --> B[æ£€æŸ¥æ˜¯å¦åº”è¯¥ç¦ç”¨]
    B -->|æ˜¯| C[è°ƒç”¨monitor.DisableChannel]
    C --> D[è®¾ç½®auto_disabled_reason]
    D --> E[è®¾ç½®auto_disabled_time]
    E --> F[æ›´æ–°æ¸ é“çŠ¶æ€ä¸ºè‡ªåŠ¨ç¦ç”¨]
    F --> G[å‘é€æ¸ é“ç¦ç”¨é‚®ä»¶é€šçŸ¥]
```

### å¤šKeyæ¸ é“é”™è¯¯å¤„ç†æµç¨‹
```mermaid
graph TD
    A[APIè¯·æ±‚å¤±è´¥] --> B[æ£€æŸ¥æ˜¯å¦åº”è¯¥ç¦ç”¨]
    B -->|æ˜¯| C[è°ƒç”¨channel.HandleKeyError]
    C --> D[è®¾ç½®Keyçš„ç¦ç”¨åŸå› å’Œæ—¶é—´]
    D --> E[å‘é€Keyç¦ç”¨é‚®ä»¶é€šçŸ¥]
    E --> F[æ£€æŸ¥æ˜¯å¦æ‰€æœ‰Keyéƒ½è¢«ç¦ç”¨]
    F -->|æ˜¯| G[è®¾ç½®æ¸ é“auto_disabled_reason='all keys disabled']
    F -->|å¦| H[æ¸ é“ç»§ç»­è¿è¡Œ]
    G --> I[æ›´æ–°æ¸ é“çŠ¶æ€ä¸ºè‡ªåŠ¨ç¦ç”¨]
    I --> J[å‘é€æ¸ é“å®Œå…¨ç¦ç”¨é‚®ä»¶é€šçŸ¥]
```

## ğŸ’¾ æ•°æ®åº“ç»“æ„

### channelsè¡¨æ–°å¢å­—æ®µ
```sql
ALTER TABLE channels ADD COLUMN auto_disabled_reason TEXT NULL;
ALTER TABLE channels ADD COLUMN auto_disabled_time BIGINT NULL;
```

### multi_key_info JSONç»“æ„
```json
{
  "is_multi_key": true,
  "key_count": 3,
  "key_status_list": {
    "0": 1,  // å¯ç”¨
    "1": 3,  // è‡ªåŠ¨ç¦ç”¨
    "2": 3   // è‡ªåŠ¨ç¦ç”¨
  },
  "key_metadata": {
    "1": {
      "disabled_reason": "Incorrect API key provided",
      "disabled_time": 1705307400,
      "status_code": 401
    },
    "2": {
      "disabled_reason": "You exceeded your current quota",
      "disabled_time": 1705310800,
      "status_code": 429
    }
  }
}
```

## ğŸ“§ é‚®ä»¶é€šçŸ¥ç±»å‹

### 1. å•Keyæ¸ é“ç¦ç”¨é€šçŸ¥
```
ä¸»é¢˜ï¼šæ¸ é“ã€ŒOpenAI-GPT4ã€ï¼ˆ#123ï¼‰å·²è¢«ç¦ç”¨
å†…å®¹ï¼šåŒ…å«å…·ä½“é”™è¯¯åŸå› å’Œç¦ç”¨æ—¶é—´
```

### 2. å¤šKeyæ¸ é“Keyç¦ç”¨é€šçŸ¥
```
ä¸»é¢˜ï¼šå¤šKeyæ¸ é“ã€ŒOpenAI-Multiã€ï¼ˆ#456ï¼‰ä¸­çš„Keyå·²è¢«ç¦ç”¨
å†…å®¹ï¼šåŒ…å«Keyç´¢å¼•ã€è„±æ•Keyã€é”™è¯¯åŸå› ã€çŠ¶æ€ç 
```

### 3. å¤šKeyæ¸ é“å®Œå…¨ç¦ç”¨é€šçŸ¥
```
ä¸»é¢˜ï¼šå¤šKeyæ¸ é“ã€ŒOpenAI-Multiã€ï¼ˆ#456ï¼‰å·²è¢«å®Œå…¨ç¦ç”¨
å†…å®¹ï¼šè¯´æ˜æ‰€æœ‰Keyéƒ½å·²ç¦ç”¨ï¼ŒåŸå› æ˜¾ç¤ºä¸º"all keys disabled"
```

## ğŸš€ éƒ¨ç½²è¯´æ˜

1. **æ•°æ®åº“è¿ç§»**ï¼šæ‰§è¡Œ `migration_auto_disable_reason.sql`
2. **ä»£ç éƒ¨ç½²**ï¼šéƒ¨ç½²æ›´æ–°åçš„ä»£ç 
3. **éªŒè¯æµ‹è¯•**ï¼š
   - æµ‹è¯•å•Keyæ¸ é“è‡ªåŠ¨ç¦ç”¨
   - æµ‹è¯•å¤šKeyæ¸ é“å•Keyç¦ç”¨
   - æµ‹è¯•å¤šKeyæ¸ é“å…¨Keyç¦ç”¨

## âœ… éªŒè¯æ¸…å•

- [ ] å•Keyæ¸ é“é”™è¯¯æ—¶æ­£ç¡®è®°å½•ç¦ç”¨åŸå› 
- [ ] å¤šKeyæ¸ é“å•Keyé”™è¯¯æ—¶åªç¦ç”¨è¯¥Key
- [ ] å¤šKeyæ¸ é“æ‰€æœ‰Keyç¦ç”¨æ—¶æ¸ é“æ ‡è®°ä¸º"all keys disabled"
- [ ] å„ç±»é‚®ä»¶é€šçŸ¥æ­£å¸¸å‘é€
- [ ] å‰ç«¯èƒ½æ­£ç¡®æ˜¾ç¤ºç¦ç”¨åŸå› 
- [ ] å¤šKeyç®¡ç†é¡µé¢æ˜¾ç¤ºKeyçº§åˆ«çš„ç¦ç”¨ä¿¡æ¯

è¿™ä¸ªå®ç°å®Œå…¨ç¬¦åˆæ‚¨çš„éœ€æ±‚ï¼š
- âœ… å•Keyç›´æ¥ç¦ç”¨ï¼Œæ˜¾ç¤ºå…·ä½“åŸå› 
- âœ… å¤šKeyåœ¨Keyç®¡ç†é¡µé¢æ˜¾ç¤ºæ¯ä¸ªKeyçš„ç¦ç”¨åŸå› 
- âœ… å¤šKeyå…¨ç¦ç”¨æ—¶æ˜¾ç¤º"all keys disabled"
