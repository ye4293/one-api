# One API 手动部署说明

## 概述

本部署方案使用 **Docker** 运行依赖服务（MySQL 和 Redis），手动编译运行 one-api 服务。

## 部署架构

```
┌─────────────────────────────────────┐
│         one-api 服务                │
│      (手动编译运行的 Go 程序)        │
│         端口: 3000                   │
└─────────────┬───────────────────────┘
              │
              │ 连接
              │
    ┌─────────┴──────────┐
    │                    │
    ▼                    ▼
┌─────────┐        ┌─────────┐
│  MySQL  │        │  Redis  │
│ (Docker)│        │ (Docker)│
│ :3306   │        │  :6379  │
└─────────┘        └─────────┘
```

## 前置要求

### 必需软件
- **Docker** (版本 >= 20.10)
- **Docker Compose** (版本 >= 1.29)
- **Go** (版本 >= 1.19)
- **Node.js** (版本 >= 14.x，用于构建前端)
- **npm** (版本 >= 6.x，通常随 Node.js 安装)
- **Git** (用于克隆代码)

### 系统要求
- **内存**: 至少 2GB 可用内存
- **磁盘**: 至少 5GB 可用空间
- **操作系统**: Linux / macOS / Windows (WSL2)

## 文件说明

### 1. `docker-compose-deps.yml`
仅包含依赖服务的 Docker Compose 配置文件：
- **MySQL 8.2.0** - 主数据库
- **Redis latest** - 缓存服务

### 2. `deploy.sh`
一键部署脚本，提供完整的服务管理功能。

## 快速开始

### 第一步：检查依赖

```bash
# 检查 Docker
docker --version

# 检查 Docker Compose
docker-compose --version

# 检查 Go
go version

# 检查 Node.js
node --version

# 检查 npm
npm --version

# 检查 Git
git --version
```

### 第二步：启动服务

```bash
# 进入项目目录
cd /path/to/one-api

# 一键启动所有服务
./deploy.sh start
```

脚本会自动执行以下操作：
1. ✅ 检查依赖项（Docker、Go、Node.js、npm）
2. ✅ 创建必要目录
3. ✅ 启动 Docker 服务（MySQL 和 Redis）
4. ✅ 等待服务就绪
5. ✅ 构建前端项目（React）
6. ✅ 编译后端项目（Go）
7. ✅ 启动 one-api 服务

### 第三步：访问服务

启动成功后，访问：
```
http://localhost:3000
```

默认管理员账号（首次启动后在界面创建）。

## 命令详解

### 启动服务
```bash
./deploy.sh start
```
启动所有服务（自动构建前端和后端，然后启动）

### 停止服务
```bash
./deploy.sh stop
```
停止所有服务（Docker + one-api）

### 重启服务
```bash
./deploy.sh restart
```
重启 one-api 服务（不重启 Docker 服务）

### 查看状态
```bash
./deploy.sh status
```
显示所有服务的运行状态（包括前端构建状态）

### 查看日志
```bash
./deploy.sh logs
```
实时查看 one-api 日志（Ctrl+C 退出）

### 构建项目
```bash
# 构建前端 + 后端
./deploy.sh build

# 仅构建前端
./deploy.sh build-web

# 仅编译后端
./deploy.sh build-go
```

### 清理前端构建产物
```bash
./deploy.sh clean-web
```

### 帮助信息
```bash
./deploy.sh help
```
显示所有可用命令

## 自定义配置

### 修改端口
```bash
PORT=8080 ./deploy.sh start
```

### 选择前端主题
```bash
# 使用 default 主题（默认）
WEB_THEME=default ./deploy.sh start

# 使用 berry 主题（Material-UI 风格，功能丰富）
WEB_THEME=berry ./deploy.sh start

# 使用 air 主题（现代化设计）
WEB_THEME=air ./deploy.sh start
```

### 跳过前端构建
```bash
# 如果不需要构建前端（使用已有构建产物）
BUILD_WEB=false ./deploy.sh start
```

### 构建所有主题
```bash
# 一次性构建所有主题
for theme in default berry air; do
    WEB_THEME=$theme ./deploy.sh build-web
done
```

### 修改数据库连接
```bash
# 编辑脚本中的环境变量
vi deploy.sh

# 修改以下配置
export SQL_DSN="oneapi:123456@tcp(127.0.0.1:3306)/one-api"
```

### 修改 Redis 连接
```bash
export REDIS_CONN_STRING="redis://127.0.0.1:6379"
```

### 修改会话密钥
```bash
SESSION_SECRET="your_secret_key" ./deploy.sh start
```

## 目录结构

```
one-api/
├── deploy.sh                    # 部署脚本
├── docker-compose-deps.yml      # Docker 依赖服务配置
├── one-api                      # 编译后的二进制文件
├── one-api.pid                  # 进程 PID 文件
├── web/                         # 前端项目
│   ├── default/                 # 默认主题源码
│   ├── berry/                   # Berry 主题源码
│   ├── air/                     # Air 主题源码
│   └── build/                   # 构建产物目录
│       ├── default/             # 默认主题构建产物
│       ├── berry/               # Berry 主题构建产物
│       └── air/                 # Air 主题构建产物
├── data/                        # 数据目录
│   ├── mysql/                   # MySQL 数据
│   ├── redis/                   # Redis 数据
│   └── oneapi/                  # one-api 数据
└── logs/                        # 日志目录
    ├── oneapi.out               # 标准输出日志
    └── oneapi-YYYYMMDD.log      # 应用日志
```

## 常见问题

### 1. 端口冲突

**问题**: MySQL 或 Redis 端口已被占用

**解决方案**:
```bash
# 方案一：停止占用端口的服务
sudo lsof -i :3306
sudo lsof -i :6379

# 方案二：修改 docker-compose-deps.yml 中的端口映射
vi docker-compose-deps.yml
# 修改 ports 配置
```

### 2. Docker 服务启动失败

**问题**: 权限不足或 Docker 未运行

**解决方案**:
```bash
# 启动 Docker 服务
sudo systemctl start docker

# 将当前用户加入 docker 组
sudo usermod -aG docker $USER
newgrp docker
```

### 3. 前端构建失败

**问题**: npm 依赖安装失败

**解决方案**:
```bash
# 设置 npm 镜像
npm config set registry https://registry.npmmirror.com

# 清理缓存
npm cache clean --force

# 手动构建
cd web/default
rm -rf node_modules
npm install --legacy-peer-deps
npm run build
```

### 4. 后端编译失败

**问题**: Go 依赖下载失败

**解决方案**:
```bash
# 设置 Go 代理
export GOPROXY=https://goproxy.cn,direct

# 清理缓存重新编译
go clean -modcache
./deploy.sh build-go
```

### 5. Node.js 版本过低

**问题**: Node.js 版本不满足要求

**解决方案**:
```bash
# 使用 nvm 安装最新 LTS 版本
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install --lts
nvm use --lts

# 或跳过前端构建
BUILD_WEB=false ./deploy.sh start
```

### 6. 数据库连接失败

**问题**: one-api 无法连接 MySQL

**解决方案**:
```bash
# 检查 MySQL 服务状态
docker ps | grep mysql

# 检查 MySQL 日志
docker logs one-api-mysql

# 测试连接
docker exec one-api-mysql mysql -u oneapi -p123456 -e "SELECT 1"
```

### 7. Redis 连接失败

**问题**: one-api 无法连接 Redis

**解决方案**:
```bash
# 检查 Redis 服务状态
docker ps | grep redis

# 测试连接
docker exec one-api-redis redis-cli ping
```

## 服务管理

### 仅重启 Docker 服务
```bash
cd /path/to/one-api
docker-compose -f docker-compose-deps.yml restart
```

### 仅停止 Docker 服务
```bash
docker-compose -f docker-compose-deps.yml down
```

### 仅启动 Docker 服务
```bash
docker-compose -f docker-compose-deps.yml up -d
```

### 手动启动 one-api
```bash
# 设置环境变量
export SQL_DSN="oneapi:123456@tcp(127.0.0.1:3306)/one-api"
export REDIS_CONN_STRING="redis://127.0.0.1:6379"
export SESSION_SECRET="your_secret_key"
export PORT=3000

# 前台运行（调试）
./one-api --log-dir ./logs

# 后台运行
nohup ./one-api --log-dir ./logs > ./logs/oneapi.out 2>&1 &
```

### 停止 one-api
```bash
# 查找进程
ps aux | grep one-api

# 停止进程
kill <PID>

# 或使用脚本
./deploy.sh stop
```

## 数据备份

### 备份 MySQL 数据
```bash
# 导出数据库
docker exec one-api-mysql mysqldump -u oneapi -p123456 one-api > backup.sql

# 或直接备份数据目录
tar -czf mysql-backup-$(date +%Y%m%d).tar.gz data/mysql/
```

### 恢复 MySQL 数据
```bash
# 从 SQL 文件恢复
docker exec -i one-api-mysql mysql -u oneapi -p123456 one-api < backup.sql

# 或恢复数据目录
./deploy.sh stop
rm -rf data/mysql/*
tar -xzf mysql-backup-YYYYMMDD.tar.gz
./deploy.sh start
```

### 备份 Redis 数据
```bash
# 触发 Redis 保存
docker exec one-api-redis redis-cli SAVE

# 备份 RDB 文件
cp data/redis/dump.rdb backup/dump-$(date +%Y%m%d).rdb
```

## 日志管理

### 查看实时日志
```bash
# one-api 日志
tail -f logs/oneapi.out

# MySQL 日志
docker logs -f one-api-mysql

# Redis 日志
docker logs -f one-api-redis
```

### 清理日志
```bash
# 清理 one-api 日志
rm -f logs/*.log
rm -f logs/oneapi.out

# 清理 Docker 日志
docker-compose -f docker-compose-deps.yml logs --no-color > /dev/null
```

## 性能优化

### MySQL 优化
编辑 `docker-compose-deps.yml`，添加性能参数：
```yaml
command:
  - --character-set-server=utf8mb4
  - --collation-server=utf8mb4_unicode_ci
  - --max_connections=1000
  - --innodb_buffer_pool_size=512M
```

### Redis 优化
编辑 `docker-compose-deps.yml`：
```yaml
command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
```

## 系统服务配置

### 创建 Systemd 服务（Linux）

```bash
# 创建服务文件
sudo vi /etc/systemd/system/one-api.service
```

内容如下：
```ini
[Unit]
Description=One API Service
After=network.target docker.service
Requires=docker.service

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/one-api
ExecStartPre=/usr/local/bin/docker-compose -f docker-compose-deps.yml up -d
ExecStart=/path/to/one-api/one-api --log-dir /path/to/one-api/logs
ExecStop=/bin/kill -s QUIT $MAINPID
Restart=on-failure

Environment="SQL_DSN=oneapi:123456@tcp(127.0.0.1:3306)/one-api"
Environment="REDIS_CONN_STRING=redis://127.0.0.1:6379"
Environment="SESSION_SECRET=your_secret_key"
Environment="PORT=3000"

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable one-api
sudo systemctl start one-api
sudo systemctl status one-api
```

## 监控与告警

### 健康检查
```bash
# 检查 API 状态
curl http://localhost:3000/api/status

# 检查进程
ps aux | grep one-api

# 检查端口监听
netstat -tlnp | grep 3000
```

### 简单监控脚本
创建 `monitor.sh`：
```bash
#!/bin/bash
while true; do
    if ! curl -sf http://localhost:3000/api/status > /dev/null; then
        echo "服务异常，正在重启..."
        ./deploy.sh restart
    fi
    sleep 60
done
```

## 安全建议

1. **修改默认密码**
   - MySQL root 密码
   - MySQL oneapi 用户密码
   - SESSION_SECRET

2. **启用防火墙**
```bash
# 仅允许本地访问数据库
sudo ufw allow 3000/tcp
sudo ufw enable
```

3. **使用 HTTPS**
   - 配置 Nginx 反向代理
   - 申请 SSL 证书

4. **定期备份**
   - 设置自动备份脚本
   - 异地备份数据

## 升级指南

### 升级 one-api
```bash
# 拉取最新代码
git pull origin main

# 重新编译和启动
./deploy.sh restart
```

### 升级 Docker 镜像
```bash
# 拉取最新镜像
docker-compose -f docker-compose-deps.yml pull

# 重建容器
docker-compose -f docker-compose-deps.yml up -d --force-recreate
```

## 卸载

### 完全卸载
```bash
# 停止所有服务
./deploy.sh stop

# 删除数据（谨慎操作！）
rm -rf data/
rm -rf logs/
rm -f one-api
rm -f one-api.pid
```

## 技术支持

- **项目地址**: [GitHub Repository]
- **问题反馈**: [Issues]
- **文档**: [Documentation]

---

**最后更新**: 2025-12-22

