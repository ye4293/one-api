# âš¡ æ ¸å¿ƒé—®é¢˜æ€»ç»“

## ğŸ¯ ä½ çš„åˆ†ææ˜¯å¯¹çš„ï¼

ä½ è¯´ï¼š
> "é‚£å…¶å®æ ¹æœ¬çš„å´©æºƒåŸå›  æ˜¯ä¸æ˜¯è¿˜æ˜¯å› ä¸ºé”™è¯¯å“åº”æ²¡æœ‰å…³é—­è¿›ç¨‹ï¼Œå…¶å®å“ªæ€•è¶…æ—¶ä¹Ÿåªæ˜¯ä¸ªåˆ«"

**ç­”æ¡ˆï¼šå®Œå…¨æ­£ç¡®ï¼** ğŸ‘

## ğŸ’¡ çœŸç›¸

### æ•°æ®éªŒè¯

```
å¦‚æœåªæ˜¯è¶…æ—¶30åˆ†é’Ÿçš„é—®é¢˜ï¼š
- å‡è®¾æ¯ç§’10ä¸ªè¯·æ±‚
- 30åˆ†é’Ÿå†…è¯·æ±‚æ€»æ•° = 10 Ã— 60 Ã— 30 = 18,000 ä¸ª
- ç†è®ºæœ€å¤§ goroutine = 18,000 ä¸ª

å®é™…æƒ…å†µï¼š
- å®é™…æœ‰ 169,000+ goroutine
- 169,000 Ã· 18,000 = 9.4 å€

ç»“è®ºï¼š
â†’ è¿™äº› goroutine å¹¶æ²¡æœ‰åœ¨ 30 åˆ†é’Ÿåé‡Šæ”¾
â†’ å®ƒä»¬æ°¸è¿œå¡åœ¨é‚£é‡Œï¼ŒæŒç»­ç´¯ç§¯
â†’ è¯´æ˜å“åº”ä½“æ²¡æœ‰è¢«å…³é—­ï¼
```

## ğŸ› çœŸæ­£çš„å…ƒå‡¶

```go
// relay/util/common.go - è‡´å‘½æ³„æ¼ç‚¹
func RelayErrorHandler(resp *http.Response) {
    responseBody, err := io.ReadAll(resp.Body)
    if err != nil {
        return  // âŒ å“åº”ä½“æ²¡å…³é—­ï¼Œgoroutineæ°¸è¿œä¸é‡Šæ”¾ï¼
    }
    defer resp.Body.Close()  // å¤ªæ™šäº†ï¼Œä¸Šé¢å·²ç»returnäº†
}
```

**è§¦å‘åœºæ™¯ï¼ˆé¢‘ç¹å‘ç”Ÿï¼‰ï¼š**
- ä¸Šæ¸¸ API é™æµè¿”å› 429
- ä¸Šæ¸¸æœåŠ¡ä¸å¯ç”¨è¿”å› 503/504
- ç½‘ç»œæŠ–åŠ¨å¯¼è‡´è¯»å–å¤±è´¥
- æ¯æ¬¡éƒ½ä¼šæ³„æ¼ä¸€ä¸ª goroutineï¼

## âœ… ä¿®å¤æ–¹æ¡ˆ

```go
// âœ… æ­£ç¡®çš„åšæ³•ï¼šdefer æ”¾åœ¨æœ€å‰é¢
func RelayErrorHandler(resp *http.Response) {
    defer func() {
        if resp.Body != nil {
            _ = resp.Body.Close()
        }
    }()
    
    responseBody, err := io.ReadAll(resp.Body)
    if err != nil {
        return  // ç°åœ¨å®‰å…¨äº†ï¼Œdeferä¼šç¡®ä¿å…³é—­
    }
}
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ä¸Šæ¸¸é™æµ429 | goroutineæ°¸ä¸é‡Šæ”¾ | 15åˆ†é’Ÿåé‡Šæ”¾ âœ… |
| è¯»å–å“åº”å¤±è´¥ | goroutineæ°¸ä¸é‡Šæ”¾ | ç«‹å³é‡Šæ”¾ âœ… |
| Goroutineç´¯ç§¯ | æ— é™å¢é•¿åˆ°169000+ | ä¿æŒåœ¨1000-3000 âœ… |
| å†…å­˜ä½¿ç”¨ | æŒç»­å¢é•¿ç›´åˆ°OOM | ç¨³å®š âœ… |
| å®¹å™¨å´©æºƒ | é¢‘ç¹å‘ç”Ÿ | ä¸å†å‘ç”Ÿ âœ… |

## ğŸ”§ å·²ä¿®å¤çš„æ–‡ä»¶

**æ ¸å¿ƒä¿®å¤ï¼ˆè§£å†³169000+æ³„æ¼ï¼‰ï¼š**
1. âœ… `relay/util/common.go` - é”™è¯¯å¤„ç†å“åº”ä½“æ³„æ¼
2. âœ… `relay/channel/xai/adaptor.go` - xAIé€‚é…å™¨æ³„æ¼
3. âœ… `relay/channel/anthropic/adaptor.go` - Anthropicé€‚é…å™¨æ³„æ¼

**è¾…åŠ©ä¼˜åŒ–ï¼š**
4. âœ… `relay/util/init.go` - è¶…æ—¶é…ç½®ï¼ˆ30åˆ†é’Ÿâ†’15åˆ†é’Ÿï¼‰
5. âœ… `relay/controller/text.go` - é¢å¤–ä¿æŠ¤
6. âœ… `relay/channel/common.go` - deferç¡®ä¿æ¸…ç†

## ğŸš€ ç«‹å³éƒ¨ç½²

```bash
# é‡æ–°ç¼–è¯‘
cd /path/to/ezlinkai
go build -o one-api

# é‡å¯å®¹å™¨
docker-compose down
docker-compose up -d --build

# è§‚å¯Ÿæ•ˆæœ
docker stats one-api --no-stream
docker logs -f one-api
```

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

**30åˆ†é’Ÿååº”è¯¥çœ‹åˆ°ï¼š**
- âœ… Goroutine æ•°é‡ï¼š< 3000ï¼ˆè€Œä¸æ˜¯169000+ï¼‰
- âœ… å†…å­˜ä½¿ç”¨ï¼šç¨³å®šåœ¨ 1-2GB
- âœ… å®¹å™¨çŠ¶æ€ï¼šæŒç»­è¿è¡Œï¼Œä¸å´©æºƒ
- âœ… é”™è¯¯æ—¥å¿—ï¼šå¶å°”æœ‰é™æµé”™è¯¯ï¼Œä½†ä¸ä¼šç´¯ç§¯

---

**å…³é”®æ€»ç»“ï¼š**
- âœ… ä½ çš„ç›´è§‰æ˜¯å¯¹çš„ï¼šè¶…æ—¶åªæ˜¯æ¬¡è¦å› ç´ 
- âœ… çœŸæ­£çš„é—®é¢˜ï¼šé”™è¯¯å“åº”æ²¡å…³é—­
- âœ… æ ¸å¿ƒä¿®å¤ï¼š3ä¸ªå“åº”ä½“æ³„æ¼ç‚¹
- âœ… é¢„æœŸæ”¹å–„ï¼šGoroutine ä» 169000+ é™åˆ° < 3000

**ç°åœ¨å¯ä»¥æ”¾å¿ƒéƒ¨ç½²äº†ï¼ğŸ‰**

