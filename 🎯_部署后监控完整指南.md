# 🎯 部署后监控完整指南

## ✅ 已添加的监控功能

部署修复代码后，你将获得以下监控能力：

### 1. 🌐 HTTP 监控 API

**端点：** `http://your-server:3000/api/monitor/health`

**返回示例：**
```json
{
  "status": "ok",
  "goroutines": 1234,
  "memory": {
    "alloc_mb": 256,
    "total_alloc_mb": 1024,
    "sys_mb": 512,
    "num_gc": 45
  }
}
```

### 2. 📝 自动日志记录

服务会自动每 30 秒记录一次 goroutine 数量：

```
🟢 正常情况（< 2000）: 不记录（除非开启DEBUG）
🟡 警告情况（2000-5000）: 记录到日志
🔴 危险情况（> 5000）: 记录到错误日志
```

### 3. 🛠️ 监控脚本

提供了多个现成的监控脚本：

| 脚本 | 用途 | 平台 |
|------|------|------|
| `quick_check.ps1` | 快速检查当前状态 | Windows ⭐ |
| `monitor_goroutines.ps1` | 实时监控（自动刷新）| Windows ⭐ |
| `monitor_goroutines.sh` | 实时监控（自动刷新）| Linux |
| `test_timeout.sh` | 测试超时配置 | Linux |

---

## 🚀 快速开始（3步）

### 步骤 1: 部署修复代码

```powershell
# Windows PowerShell
cd C:\Users\brows\Desktop\ezlinkai

# 编译
go build -o one-api.exe

# 重启 Docker
docker-compose down
docker-compose up -d --build
```

### 步骤 2: 等待启动（约1-2分钟）

```powershell
# 查看启动日志
docker logs -f one-api

# 看到以下信息表示成功：
# ✅ One API v1.x.x started
# ✅ monitoring endpoints enabled at /api/monitor/health
# ✅ key disable notification listener started
```

### 步骤 3: 开始监控

**Windows 用户（推荐）：**

```powershell
# 方法A: 快速检查
.\quick_check.ps1

# 方法B: 实时监控本地
.\monitor_goroutines.ps1

# 方法C: 实时监控远程服务器
.\monitor_goroutines.ps1 -ApiUrl "http://your-server-ip:3000" -Interval 5
```

**Linux/Mac 用户：**

```bash
# 快速检查
curl http://localhost:3000/api/monitor/health | jq .

# 实时监控
chmod +x monitor_goroutines.sh
./monitor_goroutines.sh http://localhost:3000 5
```

---

## 📊 监控示例

### 正常情况（修复后）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  实时监控 - [10:30:45] 运行时长: 15分30秒
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 Goroutines: 856 🟢 正常
💾 内存分配: 345 MB
💽 系统内存: 512 MB
🔄 GC次数: 23

📈 统计信息:
   最大值: 1234
   最小值: 456
   当前值: 856

✅ Goroutine 数量正常
```

### 异常情况（需要关注）

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  实时监控 - [10:35:00] 运行时长: 20分15秒
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📊 Goroutines: 6543 🔴 危险
💾 内存分配: 2048 MB
💽 系统内存: 3072 MB
🔄 GC次数: 156

📈 统计信息:
   最大值: 6543
   最小值: 456
   当前值: 6543

⚠️  警告: Goroutine 数量超过 5,000
   请检查日志，可能存在异常
```

---

## 🔍 如何判断修复是否成功？

### ✅ 修复成功的标志

**部署后 30 分钟内：**
- ✅ Goroutine 数量稳定在 < 3000
- ✅ 内存使用稳定，不持续增长
- ✅ 日志中 goroutine 数量在合理范围波动

**部署后 2 小时内：**
- ✅ Goroutine 峰值 < 3000
- ✅ 没有看到 > 5000 的情况
- ✅ 容器持续运行，没有崩溃

**部署后 24 小时：**
- ✅ Goroutine 数量长期稳定
- ✅ 内存使用稳定
- ✅ 没有收到告警

### ❌ 仍有问题的标志

- ❌ Goroutine 持续增长（从 1000 → 2000 → 3000 → ...）
- ❌ 几小时后超过 10000
- ❌ 内存持续增长
- ❌ 容器仍然崩溃

---

## 📈 监控时间表

### 第一天（重点监控）

| 时间点 | 操作 | 预期结果 |
|--------|------|---------|
| 部署后 10 分钟 | 运行 `quick_check.ps1` | Goroutines < 1000 |
| 部署后 30 分钟 | 运行 `monitor_goroutines.ps1` 观察5分钟 | 稳定在 < 2000 |
| 部署后 1 小时 | 检查日志是否有告警 | 无高goroutine告警 |
| 部署后 2 小时 | 记录峰值 | 峰值 < 3000 |
| 部署后 4 小时 | 检查内存是否增长 | 内存稳定 |
| 部署后 8 小时 | 全面检查 | 各项指标正常 |
| 部署后 24 小时 | 稳定性验证 | 持续稳定运行 |

### 第一周（常规监控）

```powershell
# 每天运行一次
.\quick_check.ps1

# 或者设置计划任务
# 任务计划程序 → 创建任务 → 每小时运行 quick_check.ps1
```

---

## 🛠️ Windows 计划任务设置

### 设置自动监控（可选）

1. 打开"任务计划程序"
2. 创建基本任务
3. 配置：
   - **名称**: OneAPI监控
   - **触发器**: 每小时
   - **操作**: 启动程序
   - **程序**: `powershell.exe`
   - **参数**: `-File "C:\Users\brows\Desktop\ezlinkai\quick_check.ps1" >> monitor.log`

---

## 📞 各种监控方式对比

| 方式 | 优点 | 缺点 | 推荐场景 |
|------|------|------|---------|
| **HTTP API** | 实时、准确 | 需要网络访问 | ⭐⭐⭐⭐⭐ 最推荐 |
| **自动日志** | 自动记录、持久化 | 需要查看日志文件 | ⭐⭐⭐⭐ 辅助使用 |
| **Docker stats** | 系统级监控 | 无法看到goroutine | ⭐⭐⭐ 配合使用 |
| **实时脚本** | 直观、彩色显示 | 需要一直运行 | ⭐⭐⭐⭐ 调试时用 |

---

## 🎓 监控最佳实践

### 第一周（密集监控）

```powershell
# 每天3次检查
.\quick_check.ps1 >> daily_check.log

# 或者实时监控30分钟
.\monitor_goroutines.ps1 -Interval 10
```

### 稳定后（常规监控）

```powershell
# 每周1-2次检查
.\quick_check.ps1

# 或者只看日志
docker logs --tail 100 one-api | Select-String "goroutine"
```

### 出现问题时（深度监控）

```powershell
# 1. 开启DEBUG模式
# 编辑 docker-compose.yml，添加 DEBUG=true

# 2. 实时监控
.\monitor_goroutines.ps1 -Interval 5

# 3. 同时查看日志
docker logs -f one-api

# 4. 收集数据
docker logs one-api > debug.log
curl http://localhost:3000/api/monitor/health > health.json
```

---

## 📱 手机/外网监控

### 方法 1: 使用监控服务

推荐的免费监控服务：
- **UptimeRobot**: https://uptimerobot.com/
- **Uptime Kuma**: 自建监控（推荐）
- **Healthchecks.io**: https://healthchecks.io/

**配置示例（UptimeRobot）：**
```
监控类型: HTTP(s)
URL: http://your-server:3000/api/monitor/health
监控间隔: 5分钟
告警条件: 关键字检测 "goroutines"
告警方式: 邮件/微信/Telegram
```

### 方法 2: 简单的公网访问

如果服务器有公网IP：

```powershell
# 从手机浏览器访问
http://your-public-ip:3000/api/monitor/health

# 或者使用在线JSON格式化工具
https://jsonformatter.org/
```

---

## 🔔 告警配置建议

### 告警级别设置

```powershell
# 脚本化告警（可加入计划任务）
$health = Invoke-RestMethod "http://localhost:3000/api/monitor/health"
$goroutines = $health.goroutines

if ($goroutines -gt 10000) {
    # 严重告警 - 发送紧急通知
    Send-MailMessage -Subject "🔴 OneAPI严重告警" -Body "Goroutines: $goroutines"
} elseif ($goroutines -gt 5000) {
    # 一般告警 - 发送警告通知
    Send-MailMessage -Subject "🟡 OneAPI警告" -Body "Goroutines: $goroutines"
}
```

---

## 📊 数据记录建议

### 建立基准线（第一天）

```powershell
# 记录第一天的数据
for ($i=0; $i -lt 24; $i++) {
    $time = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $data = Invoke-RestMethod "http://localhost:3000/api/monitor/health"
    "$time - Goroutines: $($data.goroutines)" | Out-File -Append baseline.txt
    Start-Sleep 3600  # 每小时一次
}
```

### 对比修复效果

```powershell
# 查看趋势
Get-Content baseline.txt

# 分析
# 修复前: 持续增长（1000 → 5000 → 10000 → ... → 169000）
# 修复后: 稳定波动（800 → 1200 → 900 → 1500 → 1100）
```

---

## 💡 常见监控场景

### 场景 1: 刚部署，验证修复效果

```powershell
# 立即查看
.\quick_check.ps1

# 持续监控30分钟
.\monitor_goroutines.ps1 -Interval 5

# 预期: Goroutines 应该稳定在 < 2000
```

### 场景 2: 高峰期监控

```powershell
# 业务高峰期前开始监控
.\monitor_goroutines.ps1 -Interval 10

# 观察峰值是否在合理范围
# 高峰期 3000-5000 是可接受的
```

### 场景 3: 怀疑有问题

```powershell
# 1. 立即检查
.\quick_check.ps1

# 2. 查看最近的日志
docker logs --tail 200 one-api | Select-String "goroutine|error|panic"

# 3. 开启实时监控
.\monitor_goroutines.ps1 -Interval 3

# 4. 如果确认有问题，收集数据
docker logs one-api > problem_$(Get-Date -Format 'yyyyMMdd_HHmmss').log
```

### 场景 4: 远程监控生产服务器

```powershell
# 监控远程服务器
.\monitor_goroutines.ps1 -ApiUrl "http://prod-server-ip:3000" -Interval 10

# 或者通过 SSH 隧道
ssh -L 3000:localhost:3000 user@prod-server
.\monitor_goroutines.ps1
```

---

## 🎯 监控检查清单

### 每日检查（1分钟）

```powershell
# ✅ 运行快速检查
.\quick_check.ps1

# ✅ 查看 Docker 状态
docker ps | Select-String one-api

# ✅ 检查重启次数（应该是0）
docker inspect one-api --format='{{.RestartCount}}'
```

### 每周检查（5分钟）

```powershell
# ✅ 查看一周的日志
docker logs --since 168h one-api | Select-String "High goroutine"

# ✅ 检查内存趋势
docker stats one-api --no-stream

# ✅ 运行实时监控观察5分钟
.\monitor_goroutines.ps1 -Interval 10
```

### 每月检查（10分钟）

```powershell
# ✅ 全面健康检查
.\quick_check.ps1
docker stats one-api --no-stream
docker logs --tail 500 one-api | Select-String "error"

# ✅ 性能基准对比
# 对比当前数据和第一天的 baseline.txt
```

---

## 📈 成功指标

部署修复后，成功的标志：

### 第1天
```
✅ Goroutine: 500-2000 (稳定)
✅ 内存: < 1GB (稳定)
✅ 容器: 持续运行
✅ 日志: 无严重告警
```

### 第1周
```
✅ Goroutine峰值: < 3000
✅ 平均值: 1000-1500
✅ 内存增长: 无
✅ 容器重启: 0次
```

### 第1月
```
✅ 长期稳定运行
✅ Goroutine 无持续增长趋势
✅ 无需频繁重启
```

---

## 🚨 异常处理流程

### 发现 Goroutine > 5000

```powershell
# 1. 立即检查详细信息
.\quick_check.ps1
docker logs --tail 200 one-api

# 2. 查找异常模式
docker logs --tail 500 one-api | Select-String "error|timeout|panic"

# 3. 识别问题渠道
docker logs --tail 500 one-api | Select-String "relay error"

# 4. 临时禁用问题渠道（如果找到）
# 通过Web界面禁用对应渠道

# 5. 如果持续增长，考虑重启
docker-compose restart one-api
```

### 发现 Goroutine > 10000

```powershell
# 立即操作：
# 1. 收集诊断数据
docker logs one-api > emergency_$(Get-Date -Format 'yyyyMMdd_HHmmss').log
.\quick_check.ps1 > health_$(Get-Date -Format 'yyyyMMdd_HHmmss').json

# 2. 重启服务
docker-compose restart one-api

# 3. 重启后立即监控
.\monitor_goroutines.ps1 -Interval 5

# 4. 如果问题重现，说明可能还有其他泄漏点
# 提供日志文件进行分析
```

---

## 🎉 总结

现在你有了完整的监控体系：

1. ✅ **实时 API** - 随时查看当前状态
2. ✅ **自动日志** - 后台持续记录
3. ✅ **监控脚本** - 可视化展示
4. ✅ **告警机制** - 异常及时发现

**部署后立即可用，无需额外配置！**

---

## 🔧 快速命令参考

```powershell
# ==================== Windows PowerShell ====================

# 快速检查
.\quick_check.ps1

# 实时监控
.\monitor_goroutines.ps1

# 监控远程
.\monitor_goroutines.ps1 -ApiUrl "http://server:3000"

# 查看日志
docker logs -f one-api

# 查看资源
docker stats one-api --no-stream

# ==================== 通过 HTTP API ====================

# 获取状态
curl http://localhost:3000/api/monitor/health

# 只看 goroutine 数量（需要 jq）
curl -s http://localhost:3000/api/monitor/health | jq .goroutines

# ==================== Docker 命令 ====================

# 查看日志中的 goroutine 记录
docker logs one-api | Select-String "goroutine"

# 查看最近的告警
docker logs --tail 100 one-api | Select-String "High goroutine"

# 查看容器状态
docker ps | Select-String one-api

# 重启服务
docker-compose restart one-api
```

---

**准备好了吗？部署后立即开始监控！** 🚀

