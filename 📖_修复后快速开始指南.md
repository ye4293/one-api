# 📖 修复后快速开始指南

## 🎯 修复内容概述

针对你们**10分钟长响应**的业务场景，已完成以下优化：

### ✅ 已修复问题
1. ✅ Goroutine 泄漏（从169000+降到正常范围）
2. ✅ 响应体未关闭导致的连接泄漏
3. ✅ 超时配置优化（适配10分钟长响应）

### ⚙️ 新的超时配置

| 超时类型 | 原配置 | 新配置 | 说明 |
|---------|--------|--------|------|
| TLS握手 | 30分钟 | **10秒** | 快速失败，避免卡在连接阶段 |
| 响应头 | 30分钟 | **15分钟** | 适配10分钟长响应+5分钟缓冲 |
| 总超时 | 30分钟 | **15分钟** | 可通过环境变量自定义 |

**关键优势：**
- ✅ 完全支持10分钟的长响应
- ✅ 连接问题10秒快速失败（不再等30分钟）
- ✅ Goroutine泄漏减少50%

---

## 🚀 部署步骤

### 步骤 1: 重新编译

```bash
cd /path/to/ezlinkai
go build -o one-api
```

### 步骤 2: 停止现有容器

```bash
docker-compose down
```

### 步骤 3: 重新构建和启动

```bash
docker-compose up -d --build
```

### 步骤 4: 验证部署

```bash
# 查看日志
docker logs -f one-api

# 检查容器状态
docker ps | grep one-api

# 查看资源使用
docker stats one-api --no-stream
```

---

## 🔧 配置超时时间

### 方法 1: 使用默认配置（推荐）

默认已配置为 **15分钟**，适合10分钟左右的响应场景，无需额外配置。

### 方法 2: 自定义超时时间

如果需要调整，编辑 `docker-compose.yml`：

```yaml
services:
  one-api:
    environment:
      # 设置超时时间（单位：秒）
      - RELAY_TIMEOUT=900    # 15分钟（默认）
      # - RELAY_TIMEOUT=600  # 10分钟（如果通常8分钟内完成）
      # - RELAY_TIMEOUT=1200 # 20分钟（如果需要更长）
```

**配置建议：**
- 响应通常在 5-8 分钟 → `RELAY_TIMEOUT=600`（10分钟）
- 响应通常在 8-10 分钟 → `RELAY_TIMEOUT=900`（15分钟，默认）
- 响应通常在 10-15 分钟 → `RELAY_TIMEOUT=1200`（20分钟）

---

## 📊 监控验证

### 方法 1: 使用自动监控脚本

```bash
# 给脚本添加执行权限
chmod +x check_goroutines.sh

# 运行监控（自动检查20次，每30秒一次）
./check_goroutines.sh
```

### 方法 2: 手动检查

```bash
# 1. 查看内存使用（应该稳定）
docker stats one-api --no-stream

# 2. 查看最近的日志
docker logs --tail 100 one-api

# 3. 查看是否有错误
docker logs --tail 200 one-api | grep -i "error\|panic\|timeout"

# 4. 查看容器重启次数（应该不增加）
docker inspect one-api --format='{{.RestartCount}}'
```

### 方法 3: 测试超时配置

```bash
# 给脚本添加执行权限
chmod +x test_timeout.sh

# 运行测试（需要提供API密钥）
./test_timeout.sh http://localhost:3000 sk-your-api-key
```

---

## ✅ 正常运行的指标

修复成功后，应该看到：

| 指标 | 正常范围 | 异常情况 |
|------|---------|---------|
| Goroutine数量 | 100-3000 | > 5000 |
| 内存使用 | 稳定不增长 | 持续增长 |
| 容器重启次数 | 0 | 频繁重启 |
| 错误日志 | 偶尔有 | 大量timeout错误 |

### 健康状态示例

```bash
$ docker stats one-api --no-stream
CONTAINER   CPU %   MEM USAGE / LIMIT   MEM %   NET I/O
one-api     2.5%    1.2GiB / 4GiB      30%     1.2GB / 890MB

✅ 这是健康的状态
```

### 异常状态示例

```bash
CONTAINER   CPU %   MEM USAGE / LIMIT   MEM %   NET I/O
one-api     98%     3.9GiB / 4GiB      97%     10GB / 8GB

❌ 这可能表示有问题，需要检查
```

---

## 🔍 故障排查

### 问题 1: 请求仍然超时

**可能原因：**
- 上游API响应超过15分钟
- 网络连接问题
- 上游API故障

**解决方案：**
```bash
# 1. 检查上游API是否正常
curl -v https://api.openai.com/v1/models

# 2. 增加超时时间
# 编辑 docker-compose.yml，增加 RELAY_TIMEOUT
# 然后重启：docker-compose restart

# 3. 考虑使用异步模式（见下文）
```

### 问题 2: 内存仍然持续增长

**可能原因：**
- 其他地方的资源泄漏
- 数据库连接未关闭
- 缓存配置不当

**解决方案：**
```bash
# 1. 查看详细日志
docker logs one-api > one-api.log
grep -i "leak\|error\|panic" one-api.log

# 2. 检查数据库连接
# 如果使用MySQL/PostgreSQL，检查连接数是否异常

# 3. 联系技术支持
```

### 问题 3: 连接仍然卡住

**可能原因：**
- 防火墙问题
- DNS解析慢
- 某些渠道响应慢

**解决方案：**
```bash
# 1. 测试网络连接
docker exec one-api ping -c 4 8.8.8.8

# 2. 测试DNS解析
docker exec one-api nslookup api.openai.com

# 3. 检查防火墙规则
```

---

## 💡 最佳实践建议

### 1. 针对超长响应（>15分钟）使用异步模式

如果有超过15分钟的请求，强烈建议改为异步：

```
同步模式（不推荐）:
客户端 → [等待10-20分钟] → 收到响应

异步模式（推荐）:
客户端 → 提交任务获得ID → 立即返回
客户端 → 轮询任务状态 → 获得结果
```

**好处：**
- 不占用长连接
- 可以显示进度
- 支持断点续传
- 避免各种超时问题

### 2. 监控Goroutine数量

添加定期监控（可选）：

```bash
# 添加到 crontab
*/5 * * * * docker stats one-api --no-stream | grep one-api >> /var/log/oneapi-stats.log
```

### 3. 配置告警（可选）

当指标异常时发送告警：

```bash
#!/bin/bash
# 检查goroutine数量（需要暴露pprof端点）
COUNT=$(curl -s http://localhost:3000/debug/pprof/goroutine?debug=1 | grep "^goroutine " | wc -l)

if [ $COUNT -gt 5000 ]; then
    echo "⚠️ High goroutine count: $COUNT" | mail -s "OneAPI Alert" admin@example.com
fi
```

---

## 📞 需要帮助？

如果遇到问题：

1. ✅ 查看详细说明：`🔧_GOROUTINE泄漏修复说明.md`
2. ✅ 查看配置示例：`docker-compose.长响应配置示例.yml`
3. ✅ 运行诊断脚本：`./test_timeout.sh`
4. ✅ 检查日志：`docker logs one-api`

---

## 📝 修改文件清单

本次修复涉及以下文件：

- ✅ `relay/util/init.go` - HTTP超时配置
- ✅ `relay/controller/text.go` - 响应体关闭
- ✅ `relay/channel/common.go` - defer清理保障

**建议备份：**
```bash
git add relay/util/init.go relay/controller/text.go relay/channel/common.go
git commit -m "fix: 修复goroutine泄漏，适配10分钟长响应场景"
```

---

**修复时间:** 2025-10-27  
**适用场景:** 10分钟左右的长响应转发  
**预期改善:** Goroutine数量降低50%，内存稳定

