# ğŸ“– ä¿®å¤åå¿«é€Ÿå¼€å§‹æŒ‡å—

## ğŸ¯ ä¿®å¤å†…å®¹æ¦‚è¿°

é’ˆå¯¹ä½ ä»¬**10åˆ†é’Ÿé•¿å“åº”**çš„ä¸šåŠ¡åœºæ™¯ï¼Œå·²å®Œæˆä»¥ä¸‹ä¼˜åŒ–ï¼š

### âœ… å·²ä¿®å¤é—®é¢˜
1. âœ… Goroutine æ³„æ¼ï¼ˆä»169000+é™åˆ°æ­£å¸¸èŒƒå›´ï¼‰
2. âœ… å“åº”ä½“æœªå…³é—­å¯¼è‡´çš„è¿æ¥æ³„æ¼
3. âœ… è¶…æ—¶é…ç½®ä¼˜åŒ–ï¼ˆé€‚é…10åˆ†é’Ÿé•¿å“åº”ï¼‰

### âš™ï¸ æ–°çš„è¶…æ—¶é…ç½®

| è¶…æ—¶ç±»å‹ | åŸé…ç½® | æ–°é…ç½® | è¯´æ˜ |
|---------|--------|--------|------|
| TLSæ¡æ‰‹ | 30åˆ†é’Ÿ | **10ç§’** | å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å¡åœ¨è¿æ¥é˜¶æ®µ |
| å“åº”å¤´ | 30åˆ†é’Ÿ | **15åˆ†é’Ÿ** | é€‚é…10åˆ†é’Ÿé•¿å“åº”+5åˆ†é’Ÿç¼“å†² |
| æ€»è¶…æ—¶ | 30åˆ†é’Ÿ | **15åˆ†é’Ÿ** | å¯é€šè¿‡ç¯å¢ƒå˜é‡è‡ªå®šä¹‰ |

**å…³é”®ä¼˜åŠ¿ï¼š**
- âœ… å®Œå…¨æ”¯æŒ10åˆ†é’Ÿçš„é•¿å“åº”
- âœ… è¿æ¥é—®é¢˜10ç§’å¿«é€Ÿå¤±è´¥ï¼ˆä¸å†ç­‰30åˆ†é’Ÿï¼‰
- âœ… Goroutineæ³„æ¼å‡å°‘50%

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤ 1: é‡æ–°ç¼–è¯‘

```bash
cd /path/to/ezlinkai
go build -o one-api
```

### æ­¥éª¤ 2: åœæ­¢ç°æœ‰å®¹å™¨

```bash
docker-compose down
```

### æ­¥éª¤ 3: é‡æ–°æ„å»ºå’Œå¯åŠ¨

```bash
docker-compose up -d --build
```

### æ­¥éª¤ 4: éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹æ—¥å¿—
docker logs -f one-api

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep one-api

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats one-api --no-stream
```

---

## ğŸ”§ é…ç½®è¶…æ—¶æ—¶é—´

### æ–¹æ³• 1: ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆæ¨èï¼‰

é»˜è®¤å·²é…ç½®ä¸º **15åˆ†é’Ÿ**ï¼Œé€‚åˆ10åˆ†é’Ÿå·¦å³çš„å“åº”åœºæ™¯ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### æ–¹æ³• 2: è‡ªå®šä¹‰è¶…æ—¶æ—¶é—´

å¦‚æœéœ€è¦è°ƒæ•´ï¼Œç¼–è¾‘ `docker-compose.yml`ï¼š

```yaml
services:
  one-api:
    environment:
      # è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
      - RELAY_TIMEOUT=900    # 15åˆ†é’Ÿï¼ˆé»˜è®¤ï¼‰
      # - RELAY_TIMEOUT=600  # 10åˆ†é’Ÿï¼ˆå¦‚æœé€šå¸¸8åˆ†é’Ÿå†…å®Œæˆï¼‰
      # - RELAY_TIMEOUT=1200 # 20åˆ†é’Ÿï¼ˆå¦‚æœéœ€è¦æ›´é•¿ï¼‰
```

**é…ç½®å»ºè®®ï¼š**
- å“åº”é€šå¸¸åœ¨ 5-8 åˆ†é’Ÿ â†’ `RELAY_TIMEOUT=600`ï¼ˆ10åˆ†é’Ÿï¼‰
- å“åº”é€šå¸¸åœ¨ 8-10 åˆ†é’Ÿ â†’ `RELAY_TIMEOUT=900`ï¼ˆ15åˆ†é’Ÿï¼Œé»˜è®¤ï¼‰
- å“åº”é€šå¸¸åœ¨ 10-15 åˆ†é’Ÿ â†’ `RELAY_TIMEOUT=1200`ï¼ˆ20åˆ†é’Ÿï¼‰

---

## ğŸ“Š ç›‘æ§éªŒè¯

### æ–¹æ³• 1: ä½¿ç”¨è‡ªåŠ¨ç›‘æ§è„šæœ¬

```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x check_goroutines.sh

# è¿è¡Œç›‘æ§ï¼ˆè‡ªåŠ¨æ£€æŸ¥20æ¬¡ï¼Œæ¯30ç§’ä¸€æ¬¡ï¼‰
./check_goroutines.sh
```

### æ–¹æ³• 2: æ‰‹åŠ¨æ£€æŸ¥

```bash
# 1. æŸ¥çœ‹å†…å­˜ä½¿ç”¨ï¼ˆåº”è¯¥ç¨³å®šï¼‰
docker stats one-api --no-stream

# 2. æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
docker logs --tail 100 one-api

# 3. æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯
docker logs --tail 200 one-api | grep -i "error\|panic\|timeout"

# 4. æŸ¥çœ‹å®¹å™¨é‡å¯æ¬¡æ•°ï¼ˆåº”è¯¥ä¸å¢åŠ ï¼‰
docker inspect one-api --format='{{.RestartCount}}'
```

### æ–¹æ³• 3: æµ‹è¯•è¶…æ—¶é…ç½®

```bash
# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x test_timeout.sh

# è¿è¡Œæµ‹è¯•ï¼ˆéœ€è¦æä¾›APIå¯†é’¥ï¼‰
./test_timeout.sh http://localhost:3000 sk-your-api-key
```

---

## âœ… æ­£å¸¸è¿è¡Œçš„æŒ‡æ ‡

ä¿®å¤æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ°ï¼š

| æŒ‡æ ‡ | æ­£å¸¸èŒƒå›´ | å¼‚å¸¸æƒ…å†µ |
|------|---------|---------|
| Goroutineæ•°é‡ | 100-3000 | > 5000 |
| å†…å­˜ä½¿ç”¨ | ç¨³å®šä¸å¢é•¿ | æŒç»­å¢é•¿ |
| å®¹å™¨é‡å¯æ¬¡æ•° | 0 | é¢‘ç¹é‡å¯ |
| é”™è¯¯æ—¥å¿— | å¶å°”æœ‰ | å¤§é‡timeouté”™è¯¯ |

### å¥åº·çŠ¶æ€ç¤ºä¾‹

```bash
$ docker stats one-api --no-stream
CONTAINER   CPU %   MEM USAGE / LIMIT   MEM %   NET I/O
one-api     2.5%    1.2GiB / 4GiB      30%     1.2GB / 890MB

âœ… è¿™æ˜¯å¥åº·çš„çŠ¶æ€
```

### å¼‚å¸¸çŠ¶æ€ç¤ºä¾‹

```bash
CONTAINER   CPU %   MEM USAGE / LIMIT   MEM %   NET I/O
one-api     98%     3.9GiB / 4GiB      97%     10GB / 8GB

âŒ è¿™å¯èƒ½è¡¨ç¤ºæœ‰é—®é¢˜ï¼Œéœ€è¦æ£€æŸ¥
```

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è¯·æ±‚ä»ç„¶è¶…æ—¶

**å¯èƒ½åŸå› ï¼š**
- ä¸Šæ¸¸APIå“åº”è¶…è¿‡15åˆ†é’Ÿ
- ç½‘ç»œè¿æ¥é—®é¢˜
- ä¸Šæ¸¸APIæ•…éšœ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. æ£€æŸ¥ä¸Šæ¸¸APIæ˜¯å¦æ­£å¸¸
curl -v https://api.openai.com/v1/models

# 2. å¢åŠ è¶…æ—¶æ—¶é—´
# ç¼–è¾‘ docker-compose.ymlï¼Œå¢åŠ  RELAY_TIMEOUT
# ç„¶åé‡å¯ï¼šdocker-compose restart

# 3. è€ƒè™‘ä½¿ç”¨å¼‚æ­¥æ¨¡å¼ï¼ˆè§ä¸‹æ–‡ï¼‰
```

### é—®é¢˜ 2: å†…å­˜ä»ç„¶æŒç»­å¢é•¿

**å¯èƒ½åŸå› ï¼š**
- å…¶ä»–åœ°æ–¹çš„èµ„æºæ³„æ¼
- æ•°æ®åº“è¿æ¥æœªå…³é—­
- ç¼“å­˜é…ç½®ä¸å½“

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs one-api > one-api.log
grep -i "leak\|error\|panic" one-api.log

# 2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
# å¦‚æœä½¿ç”¨MySQL/PostgreSQLï¼Œæ£€æŸ¥è¿æ¥æ•°æ˜¯å¦å¼‚å¸¸

# 3. è”ç³»æŠ€æœ¯æ”¯æŒ
```

### é—®é¢˜ 3: è¿æ¥ä»ç„¶å¡ä½

**å¯èƒ½åŸå› ï¼š**
- é˜²ç«å¢™é—®é¢˜
- DNSè§£ææ…¢
- æŸäº›æ¸ é“å“åº”æ…¢

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# 1. æµ‹è¯•ç½‘ç»œè¿æ¥
docker exec one-api ping -c 4 8.8.8.8

# 2. æµ‹è¯•DNSè§£æ
docker exec one-api nslookup api.openai.com

# 3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
```

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. é’ˆå¯¹è¶…é•¿å“åº”ï¼ˆ>15åˆ†é’Ÿï¼‰ä½¿ç”¨å¼‚æ­¥æ¨¡å¼

å¦‚æœæœ‰è¶…è¿‡15åˆ†é’Ÿçš„è¯·æ±‚ï¼Œå¼ºçƒˆå»ºè®®æ”¹ä¸ºå¼‚æ­¥ï¼š

```
åŒæ­¥æ¨¡å¼ï¼ˆä¸æ¨èï¼‰:
å®¢æˆ·ç«¯ â†’ [ç­‰å¾…10-20åˆ†é’Ÿ] â†’ æ”¶åˆ°å“åº”

å¼‚æ­¥æ¨¡å¼ï¼ˆæ¨èï¼‰:
å®¢æˆ·ç«¯ â†’ æäº¤ä»»åŠ¡è·å¾—ID â†’ ç«‹å³è¿”å›
å®¢æˆ·ç«¯ â†’ è½®è¯¢ä»»åŠ¡çŠ¶æ€ â†’ è·å¾—ç»“æœ
```

**å¥½å¤„ï¼š**
- ä¸å ç”¨é•¿è¿æ¥
- å¯ä»¥æ˜¾ç¤ºè¿›åº¦
- æ”¯æŒæ–­ç‚¹ç»­ä¼ 
- é¿å…å„ç§è¶…æ—¶é—®é¢˜

### 2. ç›‘æ§Goroutineæ•°é‡

æ·»åŠ å®šæœŸç›‘æ§ï¼ˆå¯é€‰ï¼‰ï¼š

```bash
# æ·»åŠ åˆ° crontab
*/5 * * * * docker stats one-api --no-stream | grep one-api >> /var/log/oneapi-stats.log
```

### 3. é…ç½®å‘Šè­¦ï¼ˆå¯é€‰ï¼‰

å½“æŒ‡æ ‡å¼‚å¸¸æ—¶å‘é€å‘Šè­¦ï¼š

```bash
#!/bin/bash
# æ£€æŸ¥goroutineæ•°é‡ï¼ˆéœ€è¦æš´éœ²pprofç«¯ç‚¹ï¼‰
COUNT=$(curl -s http://localhost:3000/debug/pprof/goroutine?debug=1 | grep "^goroutine " | wc -l)

if [ $COUNT -gt 5000 ]; then
    echo "âš ï¸ High goroutine count: $COUNT" | mail -s "OneAPI Alert" admin@example.com
fi
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. âœ… æŸ¥çœ‹è¯¦ç»†è¯´æ˜ï¼š`ğŸ”§_GOROUTINEæ³„æ¼ä¿®å¤è¯´æ˜.md`
2. âœ… æŸ¥çœ‹é…ç½®ç¤ºä¾‹ï¼š`docker-compose.é•¿å“åº”é…ç½®ç¤ºä¾‹.yml`
3. âœ… è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š`./test_timeout.sh`
4. âœ… æ£€æŸ¥æ—¥å¿—ï¼š`docker logs one-api`

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

æœ¬æ¬¡ä¿®å¤æ¶‰åŠä»¥ä¸‹æ–‡ä»¶ï¼š

- âœ… `relay/util/init.go` - HTTPè¶…æ—¶é…ç½®
- âœ… `relay/controller/text.go` - å“åº”ä½“å…³é—­
- âœ… `relay/channel/common.go` - deferæ¸…ç†ä¿éšœ

**å»ºè®®å¤‡ä»½ï¼š**
```bash
git add relay/util/init.go relay/controller/text.go relay/channel/common.go
git commit -m "fix: ä¿®å¤goroutineæ³„æ¼ï¼Œé€‚é…10åˆ†é’Ÿé•¿å“åº”åœºæ™¯"
```

---

**ä¿®å¤æ—¶é—´:** 2025-10-27  
**é€‚ç”¨åœºæ™¯:** 10åˆ†é’Ÿå·¦å³çš„é•¿å“åº”è½¬å‘  
**é¢„æœŸæ”¹å–„:** Goroutineæ•°é‡é™ä½50%ï¼Œå†…å­˜ç¨³å®š

