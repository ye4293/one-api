# One API 项目功能文档

## 项目概述

**One API** 是一个 AI 模型 API 聚合管理系统，采用 Go 语言开发，提供统一的接口来管理和调用多个 AI 服务提供商的 API。

### 技术栈
- **后端**: Go + Gin 框架
- **数据库**: MySQL + Redis
- **前端**: 提供三套 UI 主题（Air、Berry、Default）
- **部署**: 支持 Docker 和 Docker Compose

---

## 核心功能模块

### 1. **多渠道 AI 服务聚合**

支持 20+ 主流 AI 服务提供商的统一接口管理：

#### 文本模型渠道
- **OpenAI** - GPT 系列模型
- **Anthropic** - Claude 系列
- **Google Gemini** - Gemini 模型
- **AWS Bedrock** - Amazon 托管的多种 AI 模型
- **Azure OpenAI** - 微软 Azure 平台
- **阿里云** (Ali) - 通义千问
- **百度** (Baidu) - 文心一言
- **腾讯** (Tencent) - 混元模型
- **智谱 AI** (Zhipu) - ChatGLM
- **月之暗面** (Moonshot) - Kimi
- **DeepSeek** - DeepSeek 模型
- **豆包** (Doubao) - 字节跳动
- **零一万物** (LingYiWanWu)
- **百川智能** (Baichuan)
- **讯飞星火** (Xunfei)
- **MiniMax**
- **Mistral AI**
- **Cohere**
- **Groq**
- **Together AI**
- **Vertex AI**

#### 图像生成渠道
- **Midjourney** - AI 绘画
- **Stable Diffusion** (SD) - 开源图像生成
- **Stability AI** - 稳定扩散官方
- **Recraft** - 矢量图生成

#### 视频生成渠道
- **Runway** - AI 视频生成
- **Luma** - Dream Machine
- **可灵** (Keling)
- **Pixverse** - 视频创作
- **Viggle** - 视频编辑

---

### 2. **渠道管理功能**

**位置**: `controller/channel.go`

- ✅ 渠道增删改查 (CRUD)
- ✅ 渠道测试 - 验证 API 可用性
- ✅ 渠道状态监控
- ✅ 渠道优先级配置
- ✅ 渠道计费统计
- ✅ 渠道分组管理

**相关文件**:
- `controller/channel-test.go` - 渠道测试功能
- `controller/channel-billing.go` - 渠道计费统计
- `monitor/channel.go` - 渠道健康监控

---

### 3. **用户管理系统**

**位置**: `controller/user.go`

- ✅ 用户注册/登录
- ✅ OAuth 集成 (GitHub、Google、微信)
- ✅ 用户额度管理
- ✅ 用户分组权限
- ✅ 用户消费记录
- ✅ API Key 管理

**OAuth 集成文件**:
- `controller/github.go` - GitHub OAuth
- `controller/google.go` - Google OAuth
- `controller/wechat.go` - 微信登录

**数据模型**: `model/user.go`

---

### 4. **Token 令牌管理**

**位置**: `controller/token.go`

- ✅ Token 创建和管理
- ✅ Token 权限控制
- ✅ Token 使用统计
- ✅ Token 额度限制
- ✅ Token 过期管理

**数据模型**: `model/token.go`

---

### 5. **计费系统**

**位置**: 
- `controller/billing.go` - 用户计费
- `controller/channel-billing.go` - 渠道计费

功能特性：
- ✅ 使用量统计
- ✅ 费用计算
- ✅ 渠道成本分析
- ✅ 用户消费统计
- ✅ 余额管理
- ✅ 账单导出

**相关模块**:
- `model/bill.go` - 账单数据模型
- `relay/util/billing.go` - 计费工具函数
- `common/model-ratio.go` - 模型倍率配置
- `common/group-ratio.go` - 分组倍率

---

### 6. **充值与订单系统**

**位置**: `controller/order.go`

支持多种支付方式：

#### 兑换码系统
- **文件**: `controller/redemption.go`
- **模型**: `model/redemption.go`
- 功能：批量生成、兑换、统计

#### Stripe 支付
- **文件**: `controller/stripeCharge.go`
- **模型**: `model/charge_order.go`
- 功能：信用卡支付、订阅管理

#### 加密货币支付
- **文件**: `controller/cryptoPay.go`
- **模型**: `model/crypto.go`
- 功能：数字货币充值、自动确认

**数据模型**: 
- `model/order.go` - 订单模型
- `model/charge_order.go` - 充值订单
- `model/charge_config.go` - 充值配置

---

### 7. **日志与监控**

**位置**: 
- `controller/log.go` - 日志查询接口
- `monitor/metric.go` - 性能指标监控
- `monitor/channel.go` - 渠道健康检查
- `middleware/logger.go` - 请求日志中间件

功能特性：
- ✅ API 调用日志
- ✅ 错误日志追踪
- ✅ 性能监控
- ✅ 渠道健康检查
- ✅ 实时数据统计

**日志存储**:
- `common/logger/` - 日志处理模块
- `model/log.go` - 日志数据模型
- `logs/` - 日志文件目录

---

### 8. **仪表盘与数据分析**

**位置**: 
- `controller/dashboard.go` - 仪表盘数据接口
- `router/dashboard.go` - 仪表盘路由

功能特性：
- ✅ 使用量趋势分析
- ✅ 收入统计
- ✅ 用户增长分析
- ✅ 热门模型统计
- ✅ 渠道性能对比
- ✅ 实时数据大屏

---

### 9. **中继服务 (Relay)**

**位置**: `relay/controller/`

统一的 API 转发层，支持多种 AI 服务：

#### 核心转发接口
- **文本补全** (`text.go`) - Chat Completions、文本生成
- **图像生成** (`image.go`) - DALL-E、Midjourney 等
- **音频处理** (`audio.go`) - TTS（文本转语音）、STT（语音转文本）
- **视频生成** (`video.go`) - Runway、Luma 等
- **Midjourney 专用** (`midjourney.go`) - MJ 绘图接口
- **Stable Diffusion** (`sd.go`) - SD 图像生成

#### 中继核心功能
- ✅ 自动负载均衡
- ✅ 失败重试机制
- ✅ 渠道降级策略
- ✅ 请求限流
- ✅ 响应缓存
- ✅ 智能路由

**相关模块**:
- `relay/helper/main.go` - 中继辅助函数
- `relay/util/` - 工具函数集
  - `billing.go` - 计费逻辑
  - `common.go` - 通用工具
  - `model_mapping.go` - 模型映射
  - `relay_meta.go` - 元数据管理
  - `validation.go` - 请求验证

**数据模型**:
- `relay/model/` - 请求/响应模型
  - `general.go` - 通用模型
  - `image.go` - 图像模型
  - `video.go` - 视频模型
  - `message.go` - 消息模型
  - `tool.go` - 工具调用模型

**常量定义**:
- `relay/constant/` - 中继常量
  - `api_type.go` - API 类型
  - `relay_mode.go` - 中继模式
  - `image.go` - 图像常量

---

### 10. **模型管理**

**位置**: `controller/model.go`

功能特性：
- ✅ 模型列表管理
- ✅ 模型价格配置
- ✅ 模型倍率设置
- ✅ 模型能力定义
- ✅ 模型映射管理

**相关模块**:
- `model/ability.go` - 模型能力配置
- `common/model-ratio.go` - 模型倍率
- `relay/util/model_mapping.go` - 模型映射表

---

### 11. **安全与限流**

**位置**: `middleware/`

#### 认证与授权
- `auth.go` - 用户认证中间件
- `request-id.go` - 请求 ID 追踪

#### 安全防护
- `rate-limit.go` - 速率限制
- `turnstile-check.go` - Cloudflare Turnstile 人机验证
- `cors.go` - CORS 跨域配置
- `recover.go` - 错误恢复

#### 其他安全模块
- `common/blacklist/` - IP/用户黑名单
- `common/crypto.go` - 数据加密
- `common/rate-limit.go` - 限流实现
- `common/validate.go` - 数据验证

---

### 12. **文件管理**

**位置**: `controller/fileGo.go`

功能特性：
- ✅ 文件上传
- ✅ 文件存储
- ✅ 文件访问控制
- ✅ 图片处理

**相关模块**:
- `model/file.go` - 文件数据模型
- `common/image/` - 图片处理工具
- `common/embed-file-system.go` - 嵌入式文件系统

---

### 13. **消息推送系统**

**位置**: `common/message/`

功能模块：
- `email.go` - 邮件发送
- `message-pusher.go` - 消息推送器
- `main.go` - 消息主逻辑

支持场景：
- ✅ 邮件通知
- ✅ 系统事件通知
- ✅ 余额不足提醒
- ✅ 充值成功通知

---

### 14. **系统配置**

**位置**: 
- `controller/option.go` - 配置管理接口
- `controller/misc.go` - 杂项接口

功能特性：
- ✅ 系统参数配置
- ✅ 全局设置管理
- ✅ 环境变量管理
- ✅ 配置热更新

**相关模块**:
- `model/option.go` - 配置数据模型
- `common/config/` - 配置处理
- `common/env/` - 环境变量助手

---

### 15. **多端前端支持**

**位置**: `web/`

提供三套完整的管理后台 UI：

#### 1. Air 主题 (`web/air/`)
- 轻量现代风格
- 快速响应
- 简洁界面

#### 2. Berry 主题 (`web/berry/`)
- 功能丰富的企业级 UI
- Material-UI 风格
- 完整的数据可视化

#### 3. Default 主题 (`web/default/`)
- 默认简洁风格
- 易于定制
- 基础功能完备

**所有主题均支持**:
- ✅ 响应式布局
- ✅ 深色/浅色模式
- ✅ 多语言支持
- ✅ 数据可视化
- ✅ 移动端适配

**构建脚本**: `web/build.sh`

---

### 16. **特定服务适配器**

系统为不同的 AI 服务提供专用适配器：

#### Midjourney 服务
- **接口**: `controller/midjourney.go`
- **模型**: `model/midjourney.go`
- **中继**: `relay/channel/midjourney/`
- **通用**: `common/midjourney.go`

#### Stable Diffusion 服务
- **接口**: `controller/sd.go`
- **模型**: `model/sd.go`
- **通用**: `common/sd.go`

#### 视频生成服务
- **接口**: `controller/video.go`
- **模型**: `model/video.go`

#### Replicate 服务
- **接口**: `controller/replicate.go`

#### 图像服务
- **模型**: `model/image.go`
- **模型**: `model/flux.go` - Flux 图像模型

---

## 数据模型层

**位置**: `model/`

核心数据实体：

| 文件 | 说明 |
|------|------|
| `user.go` | 用户模型 - 用户信息、权限、额度 |
| `token.go` | API Token 模型 - 令牌管理 |
| `channel.go` | 渠道模型 - AI 服务渠道配置 |
| `log.go` | 日志模型 - 调用日志记录 |
| `bill.go` | 账单模型 - 消费记录 |
| `order.go` | 订单模型 - 充值订单 |
| `charge_order.go` | 充值订单 - Stripe 等支付订单 |
| `charge_config.go` | 充值配置 - 充值套餐配置 |
| `redemption.go` | 兑换码模型 - 兑换码管理 |
| `image.go` | 图像任务模型 - 图像生成任务 |
| `video.go` | 视频任务模型 - 视频生成任务 |
| `midjourney.go` | MJ 任务模型 - Midjourney 任务 |
| `sd.go` | SD 模型 - Stable Diffusion 配置 |
| `flux.go` | Flux 模型 - Flux 图像配置 |
| `file.go` | 文件模型 - 文件管理 |
| `ability.go` | 能力配置模型 - 模型能力定义 |
| `option.go` | 配置模型 - 系统配置 |
| `cache.go` | 缓存模型 - 缓存管理 |
| `utils.go` | 工具函数 - 数据库辅助函数 |
| `main.go` | 数据库初始化 |

---

## 中间件系统

**位置**: `middleware/`

| 中间件 | 功能 |
|--------|------|
| `auth.go` | 用户认证 - JWT/Token 验证 |
| `rate-limit.go` | 速率限制 - 防止滥用 |
| `cors.go` | CORS 配置 - 跨域支持 |
| `logger.go` | 请求日志 - 记录所有请求 |
| `cache.go` | 响应缓存 - 提高性能 |
| `distributor.go` | 智能分发 - 负载均衡 |
| `turnstile-check.go` | 人机验证 - Cloudflare |
| `recover.go` | 错误恢复 - 异常捕获 |
| `request-id.go` | 请求追踪 - 唯一标识 |
| `utils.go` | 工具函数 - 中间件辅助 |

---

## 通用工具模块

**位置**: `common/`

| 模块 | 功能 |
|------|------|
| `database.go` | 数据库连接和管理 |
| `redis.go` | Redis 缓存连接 |
| `init.go` | 系统初始化 |
| `constants.go` | 全局常量定义 |
| `utils.go` | 通用工具函数 |
| `helper/` | 辅助函数集 |
| `crypto.go` | 加密解密工具 |
| `random.go` | 随机数生成 |
| `rate-limit.go` | 限流实现 |
| `validate.go` | 数据验证 |
| `verification.go` | 验证码处理 |
| `model-ratio.go` | 模型倍率配置 |
| `group-ratio.go` | 分组倍率配置 |
| `custom-event.go` | 自定义事件系统 |
| `gin.go` | Gin 框架扩展 |
| `go-channel.go` | Go Channel 工具 |
| `render/` | 响应渲染工具 |
| `ctxkey/` | Context Key 管理 |
| `conv/` | 类型转换工具 |

---

## 路由结构

**位置**: `router/`

| 路由文件 | 说明 |
|----------|------|
| `main.go` | 路由主入口 |
| `api-router.go` | 管理 API 路由 - 用户、渠道、Token 等 |
| `relay-router.go` | 中继转发路由 - AI 服务调用 |
| `web-router.go` | Web 界面路由 - 前端页面 |
| `dashboard.go` | 仪表盘路由 - 数据统计 |

---

## 部署相关

### Docker 支持
- **Dockerfile** - 容器化构建配置
- **docker-compose.yml** - 一键部署（包含 MySQL）
- **one-api.service** - Systemd 服务配置

### 数据库
- **MySQL** - 主数据库
  - 数据目录：`data/mysql/`
  - 数据库名：`one-api`
- **Redis** - 缓存数据库

### 数据库迁移脚本
- `bin/migration_v0.2-v0.3.sql` - v0.2 到 v0.3 升级
- `bin/migration_v0.3-v0.4.sql` - v0.3 到 v0.4 升级

### 日志管理
- 日志目录：`logs/`
- 日志文件：按日期自动切割

---

## 国际化支持

**位置**: `i18n/`

- **en.json** - 英文翻译
- **translate.py** - 自动翻译脚本
- 支持多语言界面
- 动态语言切换

---

## 特色功能详解

### 1. **智能分发器**
**位置**: `middleware/distributor.go`

功能特性：
- ✅ 自动选择最优渠道
- ✅ 负载均衡算法
- ✅ 成本优化策略
- ✅ 渠道优先级
- ✅ 自动故障转移

### 2. **缓存系统**
**位置**: 
- `middleware/cache.go` - 响应缓存
- `model/cache.go` - 数据缓存
- `common/redis.go` - Redis 集成

功能特性：
- ✅ 响应结果缓存
- ✅ 配置数据缓存
- ✅ 热点数据缓存
- ✅ 缓存自动过期

### 3. **自定义事件系统**
**位置**: `common/custom-event.go`

功能特性：
- ✅ 事件驱动架构
- ✅ 异步任务处理
- ✅ 事件监听器
- ✅ 事件钩子

### 4. **多支付方式**

#### Stripe 支付
- 信用卡支付
- 订阅管理
- Webhook 回调

#### 加密货币支付
- 比特币、以太坊等
- 自动确认机制
- 汇率实时转换

#### 兑换码系统
- 批量生成兑换码
- 兑换码分组
- 使用统计

---

## API 接口分类

### 管理接口 (`router/api-router.go`)

#### 用户相关
- 用户注册/登录
- 用户信息管理
- 余额查询
- 消费记录

#### 渠道管理
- 渠道 CRUD
- 渠道测试
- 渠道监控
- 渠道计费

#### Token 管理
- Token 创建
- Token 列表
- Token 权限
- Token 统计

#### 订单相关
- 创建订单
- 订单查询
- 支付回调
- 兑换码兑换

#### 系统管理
- 系统配置
- 模型管理
- 日志查询
- 数据统计

### 中继接口 (`router/relay-router.go`)

兼容 OpenAI API 格式：
- `/v1/chat/completions` - 对话补全
- `/v1/completions` - 文本补全
- `/v1/embeddings` - 文本嵌入
- `/v1/images/generations` - 图像生成
- `/v1/audio/transcriptions` - 语音转文本
- `/v1/audio/speech` - 文本转语音
- `/v1/moderations` - 内容审核

专用服务接口：
- Midjourney 绘图接口
- Stable Diffusion 接口
- Runway 视频接口
- Luma 视频接口

---

## 监控与指标

**位置**: `monitor/`

### 渠道监控 (`channel.go`)
- ✅ 渠道可用性检测
- ✅ 响应时间监控
- ✅ 错误率统计
- ✅ 自动禁用异常渠道

### 性能指标 (`metric.go`)
- ✅ API 调用量统计
- ✅ 请求耗时分析
- ✅ 成功率统计
- ✅ 并发量监控

---

## 安全特性

### 数据加密
- **位置**: `common/crypto.go`, `controller/crypt.go`
- API Key 加密存储
- 敏感数据加密传输
- 密码哈希存储

### 访问控制
- JWT Token 认证
- API Key 认证
- 用户权限分组
- IP 黑名单

### 防护机制
- 速率限制
- 请求签名验证
- Cloudflare Turnstile
- CSRF 防护

---

## 开发与调试

### 环境配置
- 环境变量管理
- 配置文件支持
- 开发/生产环境分离

### 日志系统
- 结构化日志
- 日志级别控制
- 日志文件轮转
- 日志查询接口

### 测试工具
- 渠道测试工具
- API 测试脚本
- 性能测试

---

## 项目结构总览

```
one-api/
├── bin/                    # 脚本和工具
├── common/                 # 通用模块
│   ├── blacklist/         # 黑名单
│   ├── config/            # 配置管理
│   ├── ctxkey/            # Context Key
│   ├── env/               # 环境变量
│   ├── helper/            # 辅助函数
│   ├── image/             # 图片处理
│   ├── logger/            # 日志系统
│   ├── message/           # 消息推送
│   └── render/            # 响应渲染
├── controller/            # 控制器层
│   ├── channel.go         # 渠道管理
│   ├── user.go            # 用户管理
│   ├── token.go           # Token 管理
│   ├── billing.go         # 计费系统
│   ├── order.go           # 订单管理
│   ├── dashboard.go       # 仪表盘
│   └── ...                # 其他控制器
├── middleware/            # 中间件
│   ├── auth.go            # 认证
│   ├── rate-limit.go      # 限流
│   ├── distributor.go     # 分发器
│   └── ...                # 其他中间件
├── model/                 # 数据模型
│   ├── user.go            # 用户模型
│   ├── channel.go         # 渠道模型
│   ├── token.go           # Token 模型
│   └── ...                # 其他模型
├── relay/                 # 中继服务
│   ├── channel/           # 渠道适配器
│   │   ├── openai/        # OpenAI
│   │   ├── anthropic/     # Claude
│   │   ├── gemini/        # Gemini
│   │   └── ...            # 其他渠道
│   ├── controller/        # 中继控制器
│   ├── model/             # 中继模型
│   ├── util/              # 中继工具
│   └── constant/          # 中继常量
├── router/                # 路由
│   ├── api-router.go      # API 路由
│   ├── relay-router.go    # 中继路由
│   └── web-router.go      # Web 路由
├── monitor/               # 监控
│   ├── channel.go         # 渠道监控
│   └── metric.go          # 性能监控
├── web/                   # 前端
│   ├── air/               # Air 主题
│   ├── berry/             # Berry 主题
│   └── default/           # Default 主题
├── i18n/                  # 国际化
├── data/                  # 数据目录
│   ├── mysql/             # MySQL 数据
│   └── oneapi/            # 应用数据
├── logs/                  # 日志目录
├── main.go                # 程序入口
├── Dockerfile             # Docker 配置
├── docker-compose.yml     # Docker Compose
└── README.md              # 项目说明
```

---

## 总结

**One API** 是一个功能完整、架构清晰的 **AI API 聚合管理平台**。

### 核心优势

✅ **多渠道聚合** - 支持 20+ AI 服务商统一管理  
✅ **完整的管理系统** - 用户、权限、Token、计费一体化  
✅ **灵活的计费方案** - 支持多种计费模式和支付方式  
✅ **智能负载均衡** - 自动选择最优渠道，故障自动转移  
✅ **详细的监控日志** - 完善的监控和日志系统  
✅ **多套管理后台** - 提供三套精美的前端主题  
✅ **多模态支持** - 文本、图像、音频、视频全覆盖  
✅ **高可用设计** - 缓存、限流、降级等保障机制  
✅ **易于部署** - Docker 一键部署，支持多种环境  

### 适用场景

- **AI 创业公司** - 快速搭建 AI 服务平台
- **企业 AI 网关** - 统一管理企业内部 AI 服务
- **API 分销平台** - 提供 AI API 转售服务
- **成本优化系统** - 多渠道智能调度降低成本
- **AI 应用开发** - 为自己的 AI 应用提供后端支撑

### 技术亮点

- 🚀 高性能 Go 语言实现
- 🔄 完整的中继转发机制
- 🎯 智能负载均衡算法
- 🔐 多层安全防护
- 📊 实时数据统计分析
- 🌐 多语言国际化支持
- 🎨 多套精美 UI 主题
- 📦 开箱即用的部署方案

---

## 快速开始

### 使用 Docker Compose 部署

```bash
# 克隆项目
git clone https://github.com/your-repo/one-api.git
cd one-api

# 启动服务
docker-compose up -d

# 访问管理后台
# http://localhost:3000
```

### 手动部署

```bash
# 安装依赖
go mod download

# 编译
go build -o one-api

# 运行
./one-api
```

### 配置说明

主要配置通过环境变量或配置文件设置：

- 数据库连接
- Redis 连接
- 系统端口
- 日志级别
- 等等...

详细配置请参考项目文档。

---

## 相关链接

- **项目地址**: [GitHub Repository]
- **在线文档**: [Documentation]
- **问题反馈**: [Issues]
- **更新日志**: [Changelog]

---

**文档生成时间**: 2025-12-20  
**项目版本**: 参见 `VERSION` 文件  
**维护状态**: 活跃开发中

---

*本文档基于代码结构自动分析生成，如有疑问请参考源代码或提交 Issue。*

