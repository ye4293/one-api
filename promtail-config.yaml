# Promtail 配置文件（Docker 环境）
# 用于采集 one-api 容器日志并发送到 Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  # Loki 地址 - 可通过环境变量 LOKI_URL 覆盖
  - url: ${LOKI_URL:-http://host.docker.internal:3100/loki/api/v1/push}
    # Docker 内访问宿主机: host.docker.internal
    # K8s 或同网络: http://loki:3100/loki/api/v1/push
    # 外部服务: http://your-loki-host:3100/loki/api/v1/push

scrape_configs:
  # 普通日志（INFO/WARN/DEBUG） - 排除 error 文件
  - job_name: oneapi-general
    static_configs:
      - targets:
          - localhost
        labels:
          job: oneapi
          stream: general
          __path__: /var/log/oneapi/oneapi-[0-9]*.log
    pipeline_stages:
      # 解析 JSON - 提取需要作为标签的字段
      - json:
          expressions:
            ts: ts
            level: level
            msg: msg
            service: service
            instance: instance
            method: method
            status: status
            path: path       # API路径

      # 提取为索引标签（用于快速筛选和分组）
      - labels:
          msg:             # 消息类型（如"HTTP request"）
          level:           # 日志级别（info/warn/error）
          status:          # HTTP状态码
          path:            # API路径（如 /api/status）
      
      # 设置时间戳（使用日志中的 ts 字段）
      - timestamp:
          source: ts
          format: RFC3339Nano

      # 保留原始日志行（完整的 JSON）
      # 注释掉 output 阶段以保留完整的原始日志
      # - output:
      #     source: msg

  # 错误日志（ERROR）
  - job_name: oneapi-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: oneapi
          stream: error
          __path__: /var/log/oneapi/oneapi-error-*.log
    pipeline_stages:
      # 解析 JSON - 提取需要作为标签的字段
      - json:
          expressions:
            ts: ts
            level: level
            msg: msg
            service: service
            instance: instance
            method: method
            status: status
            path: path       # API路径

      # 提取为索引标签（用于快速筛选和分组）
      - labels:
          msg:             # 消息类型
          level:           # 日志级别
          status:          # HTTP状态码
          path:            # API路径
      
      # 设置时间戳
      - timestamp:
          source: ts
          format: RFC3339Nano

      # 保留原始日志行（完整的 JSON）
      # 注释掉 output 阶段以保留完整的原始日志
      # - output:
      #     source: msg
