# Kling API æ¥å…¥å·¥ä½œæ€»ç»“

**æ—¥æœŸ**: 2025-12-26  
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆï¼Œå¾…æµ‹è¯•éƒ¨ç½²

---

## ğŸ“‹ ä»Šæ—¥å®Œæˆå·¥ä½œ

### 1. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### 1.1 API é€ä¼ æœºåˆ¶
- âœ… 4ä¸ªè§†é¢‘ç”Ÿæˆç«¯ç‚¹å®Œå…¨é€ä¼  Kling åŸå§‹å“åº”
  - `POST /kling/v1/videos/text2video` - æ–‡ç”Ÿè§†é¢‘
  - `POST /kling/v1/videos/omni-video` - å…¨èƒ½è§†é¢‘
  - `POST /kling/v1/videos/image2video` - å›¾ç”Ÿè§†é¢‘
  - `POST /kling/v1/videos/multi-image2video` - å¤šå›¾ç”Ÿè§†é¢‘
- âœ… æŸ¥è¯¢æ¥å£ `GET /kling/v1/videos/{id}` é€ä¼  Kling API å“åº”
- âœ… å›è°ƒæ¥å£ `POST /kling/internal/callback` å®Œæ•´æ”¯æŒ Kling åè®®

#### 1.2 æ•°æ®åº“ä¼˜åŒ–
- âœ… **åŒä¸»é”®æ–¹æ¡ˆ**: æ·»åŠ è‡ªå¢ `id` ä½œä¸ºä¸»é”®ï¼Œ`task_id` ä½œä¸ºå”¯ä¸€ç´¢å¼•
- âœ… æ–°å¢ `updated_at` å­—æ®µè‡ªåŠ¨æ›´æ–°æ—¶é—´æˆ³
- âœ… æ–°å¢ `result` å­—æ®µä¿å­˜ Kling å›è°ƒå®Œæ•´ JSON
- âœ… ä¼˜åŒ–ç´¢å¼•ï¼šuser_id, channel_id, status, video_id

#### 1.3 å›è°ƒå…³è”æœºåˆ¶
- âœ… å…ˆåˆ›å»º video è®°å½•è·å–è‡ªå¢ ID
- âœ… å°† video.Id ä½œä¸º `external_task_id` æ³¨å…¥ Kling è¯·æ±‚
- âœ… å›è°ƒæ—¶ä¼˜å…ˆé€šè¿‡ `external_task_id` æŸ¥è¯¢ï¼Œtask_id å…œåº•
- âœ… å›è°ƒè·¯ç”±: `/kling/internal/callback` (æ— éœ€è·¯å¾„å‚æ•°)

#### 1.4 è®¤è¯ä¸è®¡è´¹
- âœ… JWT Token è‡ªåŠ¨ç”Ÿæˆ (AK|SK æ ¼å¼æ”¯æŒ)
- âœ… ç»Ÿä¸€çš„å‡­è¯å¤„ç†å‡½æ•° `keling.GetCredentialsAndGenerateToken()`
- âœ… åæ‰£è´¹æ¨¡å¼ï¼šæˆåŠŸåæ‰æ‰£è´¹ï¼Œæ”¯æŒåŸå­æ›´æ–°é˜²é‡å¤
- âœ… ä½™é¢é¢„æ£€æŸ¥ï¼Œé˜²æ­¢ä½™é¢ä¸è¶³

#### 1.5 çŠ¶æ€ç®¡ç†
- âœ… ä½¿ç”¨å¸¸é‡ç®¡ç†çŠ¶æ€: `TaskStatusPending/Submitted/Processing/Succeed/Failed`
- âœ… ç”Ÿæˆã€æŸ¥è¯¢ã€å›è°ƒå…¨æµç¨‹çŠ¶æ€æµè½¬
- âœ… å¤±è´¥ä»»åŠ¡ä¿å­˜å¤±è´¥åŸå› 

---

## ğŸ—‚ï¸ æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
relay/channel/kling/
â”œâ”€â”€ adaptor.go          # Kling é€‚é…å™¨ï¼ˆè¯·æ±‚è½¬æ¢ã€å“åº”å¤„ç†ï¼‰
â”œâ”€â”€ model.go            # æ•°æ®ç»“æ„å®šä¹‰ï¼ˆè¯·æ±‚/å“åº”/å›è°ƒï¼‰
â”œâ”€â”€ constants.go        # å¸¸é‡å®šä¹‰ï¼ˆçŠ¶æ€ã€è¯·æ±‚ç±»å‹ï¼‰
â”œâ”€â”€ billing.go          # è®¡è´¹é€»è¾‘
â””â”€â”€ util.go             # å·¥å…·å‡½æ•°ï¼ˆGenerateTaskID ç­‰ï¼‰

controller/
â””â”€â”€ kling_video.go      # æ§åˆ¶å™¨ï¼ˆç”Ÿæˆã€æŸ¥è¯¢ã€å›è°ƒå¤„ç†ï¼‰

bin/
â”œâ”€â”€ migration_kling_dual_key.sql    # å®Œæ•´æ•°æ®åº“è¿ç§»è„šæœ¬
â””â”€â”€ migration_add_json_data.sql     # json_data å¢é‡è„šæœ¬

docs/
â”œâ”€â”€ KLING_README.md                 # API ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ KLING_API_GUIDE.md              # è¯¦ç»†æ¥å£æŒ‡å—
â”œâ”€â”€ KLING_DEPLOYMENT.md             # éƒ¨ç½²æ–‡æ¡£
â”œâ”€â”€ KLING_DEPLOYMENT_GUIDE.md       # å®Œæ•´éƒ¨ç½²æŒ‡å—
â””â”€â”€ KLING_AUTH.md                   # JWT è®¤è¯è¯´æ˜
```

### ä¿®æ”¹æ–‡ä»¶
```
model/video.go          # æ–°å¢ json_data å­—æ®µã€GetVideoTaskByInternalId()
router/relay-router.go  # æ³¨å†Œ Kling è·¯ç”±
middleware/distributor.go  # Kling JWT Token å¤„ç†
common/model-ratio.go   # Kling æ¨¡å‹å®šä»·ï¼ˆå ä½å€¼ï¼‰
```

---

## ğŸ”„ å®Œæ•´ä¸šåŠ¡æµç¨‹

### è§†é¢‘ç”Ÿæˆæµç¨‹
```
1. ç”¨æˆ·è¯·æ±‚ POST /kling/v1/videos/text2video
   â†“
2. è®¤è¯é‰´æƒ (TokenAuth + Distribute)
   â†“
3. è®¡ç®—é¢„ä¼°è´¹ç”¨ï¼Œæ£€æŸ¥ä½™é¢
   â†“
4. åˆ›å»º video è®°å½• (status=pending, task_id="")
   è·å¾— video.Id = 12345
   â†“
5. æ„å»º Kling è¯·æ±‚
   - callback_url: https://domain/kling/internal/callback
   - external_task_id: "12345"
   â†“
6. è°ƒç”¨ Kling API (JWT Token è‡ªåŠ¨æ³¨å…¥)
   â†“
7. è·å¾— Kling å“åº” (task_id: "kl_abc123")
   â†“
8. æ›´æ–° video è®°å½•
   - task_id = "kl_abc123"
   - status = "submitted"
   â†“
9. é€ä¼  Kling åŸå§‹å“åº”ç»™å®¢æˆ·ç«¯
```

### å›è°ƒæµç¨‹
```
1. Kling ä»»åŠ¡å®Œæˆ â†’ POST /kling/internal/callback
   {
     "task_id": "kl_abc123",
     "external_task_id": "12345",
     "task_status": "succeed"
   }
   â†“
2. ä¼˜å…ˆé€šè¿‡ external_task_id=12345 æŸ¥è¯¢ video
   â†“
3. é˜²é‡å¤æ£€æŸ¥ (å·²å®Œæˆçš„ä»»åŠ¡ç›´æ¥è¿”å›)
   â†“
4. ä¿å­˜å®Œæ•´ JSON åˆ° json_data
   â†“
5. æ›´æ–°çŠ¶æ€ã€æå–è§†é¢‘URL
   â†“
6. æ‰§è¡Œè®¡è´¹ (DecreaseUserQuota)
   â†“
7. è¿”å› 200 OK
```

### æŸ¥è¯¢æµç¨‹
```
1. ç”¨æˆ·è¯·æ±‚ GET /kling/v1/videos/{task_id}
   â†“
2. ä»æ•°æ®åº“æŸ¥è¯¢ video è®°å½•ï¼ˆéªŒè¯æƒé™ï¼‰
   â†“
3. æ¯æ¬¡éƒ½è¯·æ±‚ Kling API è·å–æœ€æ–°çŠ¶æ€
   â†“
4. æ›´æ–°æ•°æ®åº“ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰
   â†“
5. é€ä¼  Kling åŸå§‹å“åº”
```

---

## ğŸ¯ åç»­è§„åˆ’

### ä¸‹å‘¨ä¸€ (ä¼˜å…ˆçº§: é«˜)
- [ ] **ç¯å¢ƒé…ç½®**
  - é…ç½® `SERVER_ADDRESS` ç¯å¢ƒå˜é‡ï¼ˆç”¨äºå›è°ƒURLï¼‰
  - ç¡®è®¤ Kling æ¸ é“çš„ Base URL è®¾ç½®

- [ ] **æ•°æ®åº“éƒ¨ç½²**
  ```bash
  mysql -u root -p one-api < bin/migration_kling_dual_key.sql
  ```

- [ ] **åŠŸèƒ½æµ‹è¯•**
  - æµ‹è¯•æ–‡ç”Ÿè§†é¢‘æ¥å£
  - æµ‹è¯•å›è°ƒæœºåˆ¶ (ä½¿ç”¨ ngrok/å†…ç½‘ç©¿é€)
  - éªŒè¯é€ä¼ å“åº”æ ¼å¼
  - æµ‹è¯•è®¡è´¹é€»è¾‘

- [ ] **æ¸ é“é…ç½®**
  - ç®¡ç†åå°åˆ›å»º Kling æ¸ é“ (ChannelType=41)
  - é…ç½® AK|SK (æ ¼å¼: `your_ak|your_sk`)
  - æµ‹è¯• JWT Token ç”Ÿæˆ

### ä¸­æœŸ (æœ¬å‘¨å®Œæˆ)
- [ ] **å®šä»·é…ç½®**
  - ç¡®è®¤ Kling å®˜æ–¹ä»·æ ¼
  - æ›´æ–° `common/model-ratio.go` ä¸­çš„å®šä»·
  - éªŒè¯è®¡è´¹å‡†ç¡®æ€§

- [ ] **ç›‘æ§å‘Šè­¦**
  - æ·»åŠ å›è°ƒå¤±è´¥ç›‘æ§
  - æ·»åŠ æ‰£è´¹å¤±è´¥å‘Šè­¦
  - ç»Ÿè®¡è§†é¢‘ç”ŸæˆæˆåŠŸç‡

- [ ] **æ–‡æ¡£å®Œå–„**
  - è¡¥å……å®é™…æµ‹è¯•ç»“æœ
  - æ·»åŠ å¸¸è§é—®é¢˜ FAQ
  - å‡†å¤‡ç”¨æˆ·ä½¿ç”¨æŒ‡å—

### é•¿æœŸä¼˜åŒ–
- [ ] **æ€§èƒ½ä¼˜åŒ–**
  - å›è°ƒå¤„ç†å¼‚æ­¥åŒ–
  - æ·»åŠ æŸ¥è¯¢ç¼“å­˜ï¼ˆé’ˆå¯¹å·²å®Œæˆä»»åŠ¡ï¼‰
  - æ‰¹é‡æŸ¥è¯¢æ¥å£

- [ ] **åŠŸèƒ½å¢å¼º**
  - æ”¯æŒè§†é¢‘ç»­å†™ (parent_video)
  - æ”¯æŒé•œå¤´æ§åˆ¶å‚æ•°
  - æ·»åŠ è¿›åº¦æŸ¥è¯¢æ¥å£

- [ ] **ç¨³å®šæ€§æå‡**
  - å›è°ƒé‡è¯•æœºåˆ¶
  - å¤±è´¥ä»»åŠ¡è‡ªåŠ¨æŸ¥è¯¢
  - é•¿æ—¶é—´æœªå®Œæˆä»»åŠ¡å‘Šè­¦

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### éƒ¨ç½²å‰æ£€æŸ¥
1. âœ… æ•°æ®åº“å¤‡ä»½
2. âœ… é…ç½®å›è°ƒåŸŸå (`SERVER_ADDRESS`)
3. âœ… ç¡®è®¤ Kling æ¸ é“ AK/SK æ ¼å¼æ­£ç¡®
4. âœ… æµ‹è¯• JWT Token ç”Ÿæˆ
5. âœ… éªŒè¯å›è°ƒ URL å¯è®¿é—®æ€§

### å·²çŸ¥é™åˆ¶
- âš ï¸ å®šä»·ä¸ºå ä½å€¼ï¼Œéœ€ç¡®è®¤å®˜æ–¹ä»·æ ¼
- âš ï¸ å›è°ƒURLéœ€è¦å…¬ç½‘å¯è®¿é—®
- âš ï¸ å¦‚æœæ²¡æœ‰é…ç½® `SERVER_ADDRESS`ï¼Œå›è°ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼ˆåªèƒ½è½®è¯¢æŸ¥è¯¢ï¼‰

### å¾…ç¡®è®¤
- [ ] Kling å®˜æ–¹å®šä»·ç­–ç•¥
- [ ] å›è°ƒé‡è¯•æ¬¡æ•°å’Œé—´éš”
- [ ] è§†é¢‘URLæœ‰æ•ˆæœŸ (å®˜æ–¹è¯´æ˜30å¤©)
- [ ] æ˜¯å¦éœ€è¦è‡ªåŠ¨è½¬å­˜è§†é¢‘

---

## ğŸ“Š æŠ€æœ¯äº®ç‚¹

1. **é€ä¼ è®¾è®¡**: å®Œå…¨éµå¾ª Kling åŸå§‹åè®®ï¼Œå®¢æˆ·ç«¯å¯ç›´æ¥ä½¿ç”¨ Kling SDK
2. **åŒä¸»é”®ä¼˜åŒ–**: 10-100å€æŸ¥è¯¢æ€§èƒ½æå‡
3. **æ™ºèƒ½å…³è”**: external_task_id æœºåˆ¶ç¡®ä¿å›è°ƒå¯é æ€§
4. **ç»Ÿä¸€è®¤è¯**: JWT Token è‡ªåŠ¨ç”Ÿæˆï¼Œæ”¯æŒå¤šå¯†é’¥
5. **åŸå­è®¡è´¹**: é˜²é‡å¤æ‰£è´¹ï¼Œç¡®ä¿è´¦åŠ¡å‡†ç¡®
6. **å®Œæ•´å®¡è®¡**: json_data ä¿å­˜å®Œæ•´å›è°ƒæ•°æ®

---

## ğŸ“ è”ç³»æ–¹å¼

**é—®é¢˜åé¦ˆ**: ç›´æ¥æŸ¥çœ‹æ—¥å¿— `logs/oneapi.out`  
**ç´§æ€¥é—®é¢˜**: æ£€æŸ¥ `video` è¡¨çš„ `json_data` å­—æ®µ

---

**åˆ›å»ºæ—¶é—´**: 2025-12-26  
**æœ€åæ›´æ–°**: 2025-12-26  
**ä¸‹æ¬¡å›é¡¾**: 2025-12-30 (ä¸‹å‘¨ä¸€)

