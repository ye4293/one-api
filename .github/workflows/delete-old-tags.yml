name: åˆ é™¤ Docker Hub æ—§ç‰ˆæœ¬ Tag

on:
  workflow_dispatch:
    inputs:
      tags:
        description: 'è¦åˆ é™¤çš„ tag åˆ—è¡¨ï¼ˆç”¨ç©ºæ ¼åˆ†éš”ï¼Œå¦‚: 1.0 2.0 3.0ï¼‰'
        required: true
        default: '1.0 2.0 3.0 4.0 5.0'
      confirm:
        description: 'ç¡®è®¤åˆ é™¤ï¼ˆè¾“å…¥ yes ç¡®è®¤ï¼‰'
        required: true
        default: 'no'

env:
  DOCKER_REGISTRY: ye4293xx7
  IMAGE_NAME: one-api

jobs:
  delete-tags:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'

    steps:
      - name: éªŒè¯è¾“å…¥
        run: |
          echo "## ğŸ—‘ï¸ åˆ é™¤ Docker Hub Tag" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ä»“åº“:** ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**è¦åˆ é™¤çš„ tag:** ${{ github.event.inputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: å®‰è£… jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: åˆ é™¤ Docker Hub Tag
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail

          NAMESPACE="${{ env.DOCKER_REGISTRY }}"
          REPO="${{ env.IMAGE_NAME }}"
          TAGS_INPUT="${{ github.event.inputs.tags }}"

          # éªŒè¯å‡­è¯
          if [[ -z "${DOCKERHUB_USERNAME:-}" || -z "${DOCKERHUB_TOKEN:-}" ]]; then
            echo "âŒ Docker Hub å‡­è¯ç¼ºå¤±ï¼"
            echo "è¯·åœ¨ GitHub Settings > Secrets ä¸­è®¾ç½®:"
            echo "  - DOCKERHUB_USERNAME"
            echo "  - DOCKERHUB_TOKEN"
            exit 1
          fi

          echo "=========================================="
          echo "Docker Hub Tag åˆ é™¤å·¥å…·"
          echo "ä»“åº“: ${NAMESPACE}/${REPO}"
          echo "=========================================="
          echo ""

          # è·å– JWT
          echo "æ­£åœ¨ç™»å½• Docker Hub..."
          JWT=$(curl -fsSL \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${DOCKERHUB_USERNAME}\",\"password\":\"${DOCKERHUB_TOKEN}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)

          if [[ -z "${JWT}" || "${JWT}" == "null" ]]; then
            echo "âŒ ç™»å½•å¤±è´¥ï¼"
            exit 1
          fi

          echo "âœ… ç™»å½•æˆåŠŸ"
          echo ""

          # è½¬æ¢è¾“å…¥ä¸ºæ•°ç»„
          IFS=' ' read -ra TAGS_TO_DELETE <<< "${TAGS_INPUT}"

          SUCCESS=0
          FAILED=0
          SKIPPED=0

          # åˆ é™¤æ¯ä¸ª tag
          for TAG in "${TAGS_TO_DELETE[@]}"; do
            echo "åˆ é™¤ ${NAMESPACE}/${REPO}:${TAG}"

            HTTP_CODE=$(curl -sL -w "%{http_code}" -X DELETE \
              -H "Authorization: JWT ${JWT}" \
              "https://hub.docker.com/v2/repositories/${NAMESPACE}/${REPO}/tags/${TAG}/" \
              -o /dev/null)

            if [[ "${HTTP_CODE}" == "204" || "${HTTP_CODE}" == "200" ]]; then
              echo "  âœ… æˆåŠŸ"
              SUCCESS=$((SUCCESS + 1))
            elif [[ "${HTTP_CODE}" == "404" ]]; then
              echo "  âš ï¸  Tag ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              SKIPPED=$((SKIPPED + 1))
            else
              echo "  âŒ å¤±è´¥ (HTTP ${HTTP_CODE})"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "=========================================="
          echo "åˆ é™¤å®Œæˆï¼"
          echo "æˆåŠŸ: ${SUCCESS}, è·³è¿‡: ${SKIPPED}, å¤±è´¥: ${FAILED}"
          echo "=========================================="

          # å†™å…¥ summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š åˆ é™¤ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æ•°é‡ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… æˆåŠŸ | ${SUCCESS} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ è·³è¿‡ | ${SKIPPED} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ å¤±è´¥ | ${FAILED} |" >> $GITHUB_STEP_SUMMARY

          # å¦‚æœæœ‰å¤±è´¥ï¼Œé€€å‡ºä»£ç ä¸º 1
          if [[ ${FAILED} -gt 0 ]]; then
            exit 1
          fi

      - name: éªŒè¯åˆ é™¤ç»“æœ
        run: |
          echo "éªŒè¯ tag æ˜¯å¦å·²åˆ é™¤..."
          TAGS_INPUT="${{ github.event.inputs.tags }}"
          IFS=' ' read -ra TAGS_TO_DELETE <<< "${TAGS_INPUT}"

          for TAG in "${TAGS_TO_DELETE[@]}"; do
            HTTP_CODE=$(curl -sL -w "%{http_code}" -o /dev/null \
              "https://hub.docker.com/v2/repositories/${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}/tags/${TAG}")

            if [[ "${HTTP_CODE}" == "404" ]]; then
              echo "âœ… ${TAG} å·²ç¡®è®¤åˆ é™¤"
            else
              echo "âš ï¸  ${TAG} å¯èƒ½ä»ç„¶å­˜åœ¨ (HTTP ${HTTP_CODE})"
            fi
          done
