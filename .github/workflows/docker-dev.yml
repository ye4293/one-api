name: Build Dev Image

on:
  push:
    branches:
      - dev
  workflow_dispatch:   # 支持手动触发

env:
  DOCKER_REGISTRY: ye4293xx7
  IMAGE_NAME: one-api-test

permissions:
  contents: read
  packages: write

jobs:
  build-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: 检查仓库 URL
        run: |
          REPO_URL=$(git config --get remote.origin.url)
          if [[ $REPO_URL == *"pro" ]]; then
            echo "跳过 pro 仓库的构建"
            exit 1
          fi

      - name: 保存版本信息
        id: version
        run: |
          VERSION="dev-$(git rev-parse --short HEAD)-$(date +%Y%m%d-%H%M%S)"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          echo "$VERSION" > VERSION
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 登录 GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 构建并推送开发镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64    # 测试环境只构建 amd64，速度快
          push: true
          tags: |
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.timestamp }}
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.timestamp }}
          cache-from: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: 清理 Docker Hub 旧镜像（保留最新 5 个）
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          set -euo pipefail
          NAMESPACE="${{ env.DOCKER_REGISTRY }}"
          REPO="${{ env.IMAGE_NAME }}"
          KEEP=5

          if [[ -z "${DOCKERHUB_USERNAME:-}" || -z "${DOCKERHUB_TOKEN:-}" ]]; then
            echo "Docker Hub 凭证缺失，跳过清理"
            exit 0
          fi

          echo "获取 Docker Hub JWT..."
          JWT=$(curl -fsSL \
            -H "Content-Type: application/json" \
            -d "{\"username\":\"${DOCKERHUB_USERNAME}\",\"password\":\"${DOCKERHUB_TOKEN}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)

          if [[ -z "${JWT}" || "${JWT}" == "null" ]]; then
            echo "获取 JWT 失败，跳过清理"
            exit 0
          fi

          echo "获取 tag 列表（按更新时间排序）..."
          TAGS=$(curl -fsSL -H "Authorization: JWT ${JWT}" \
            "https://hub.docker.com/v2/repositories/${NAMESPACE}/${REPO}/tags?page_size=100&ordering=-last_updated" \
            | jq -r '.results[].name')

          # 过滤出时间戳格式的 tag（排除 latest 和 buildcache）
          TIMESTAMP_TAGS=$(echo "$TAGS" | grep -E '^[0-9]{8}-[0-9]{6}$' || true)
          
          # 计算需要删除的 tag
          DELETE_TAGS=$(echo "$TIMESTAMP_TAGS" | tail -n +$((KEEP + 1)))
          
          if [[ -z "$DELETE_TAGS" ]]; then
            echo "没有需要删除的旧 tag"
          else
            echo "将删除以下旧 tag："
            echo "$DELETE_TAGS"
            for TAG in $DELETE_TAGS; do
              echo "删除 ${NAMESPACE}/${REPO}:${TAG}"
              curl -fsSL -X DELETE \
                -H "Authorization: JWT ${JWT}" \
                "https://hub.docker.com/v2/repositories/${NAMESPACE}/${REPO}/tags/${TAG}/" || true
            done
          fi
          echo "Docker Hub 清理完成"

      - name: 清理 GHCR 旧镜像（保留最新 5 个）
        uses: actions/delete-package-versions@v5
        with:
          package-type: container
          package-name: ${{ github.event.repository.name }}
          min-versions-to-keep: 5
          ignore-versions: ^latest$

      - name: 输出构建信息
        run: |
          echo "## ✅ 测试镜像构建完成！" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**分支:** ${{ steps.version.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "**版本:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**提交:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 镜像标签" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 测试服务器拉取命令" >> $GITHUB_STEP_SUMMARY
          echo "#### 拉取 latest（可能有缓存）" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose restart one-api" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### 拉取指定时间戳版本（确保最新）" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "docker tag ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.timestamp }} ${{ env.DOCKER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker-compose restart one-api" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
